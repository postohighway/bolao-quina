<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel do Admin (Walde)</title>
  <style>
    :root{
      --green:#2e7d32; --green2:#1b5e20;
      --bg:#f3f5f7; --card:#ffffff; --line:#e6eaef;
      --warn:#fff3cd; --warn-border:#ffecb5;
      --danger:#f8d7da; --danger-border:#f5c2c7;
      --ok:#d1e7dd; --ok-border:#badbcc;
      --hdr:#f6b400;
      --blue:#1976d2; --red:#c62828; --gray:#6b7280;
    }
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{background:var(--green);color:#fff;padding:16px 12px;font-weight:800;text-align:center;font-size:20px}
    .wrap{max-width:1180px;margin:14px auto;padding:0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:14px}
    .mini{flex:1;min-width:220px}
    .mini h4{margin:0 0 6px 0;color:#111;font-size:14px;font-weight:800}
    .mini .num{font-size:44px;font-weight:900;line-height:1}
    .mini small{color:var(--gray)}
    .section{margin-top:12px}
    .section h3{margin:0 0 10px 0}
    label{font-weight:700;font-size:13px}
    input,select{width:100%;padding:12px 12px;border:1px solid #d7dde6;border-radius:10px;font-size:16px;background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
    .btn{cursor:pointer;border:0;border-radius:12px;padding:12px 14px;font-weight:900;font-size:16px}
    .btn.green{background:var(--green);color:#fff}
    .btn.green:hover{background:var(--green2)}
    .btn.gray{background:#616b7a;color:#fff}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.red{background:var(--red);color:#fff}
    .btn.sm{padding:8px 12px;border-radius:10px;font-size:14px}
    .muted{color:var(--gray);font-size:13px}
    .err{background:var(--danger);border:1px solid var(--danger-border);color:#842029;padding:10px;border-radius:12px;margin-top:10px;white-space:pre-wrap}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:var(--hdr);color:#111;padding:12px 10px;font-weight:900;text-align:left}
    thead th:first-child{border-top-left-radius:14px}
    thead th:last-child{border-top-right-radius:14px}
    tbody td{background:#fff;border-bottom:1px solid var(--line);padding:10px 10px;vertical-align:middle}
    tbody tr:nth-child(even) td{background:#f7fbf7}
    .pill{display:inline-block;padding:7px 12px;border-radius:10px;font-weight:900}
    .pill.ok{background:var(--green);color:#fff}
    .pill.no{background:#cfd8dc;color:#111}
    .tag{font-size:12px;color:var(--gray)}
    .statusRow-nao_entrou td{background:#fdecee !important}
    .statusRow-prometeu td{background:#fff6d6 !important}
    .statusRow-pago td{background:#e8f6ed !important}
    .flash{outline:3px solid #ff9800; outline-offset:-3px}
    .searchBox{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:end}
    .results{margin-top:10px;border:1px solid var(--line);border-radius:14px;background:#fff;overflow:hidden}
    .resItem{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid var(--line)}
    .resItem:first-child{border-top:0}
    .resName{font-weight:900}
    .resMeta{font-size:12px;color:var(--gray)}
    @media (max-width:860px){
      .grid2,.grid3{grid-template-columns:1fr}
      header{font-size:18px}
    }
  </style>
</head>
<body>
<header>Bolão – Painel do Admin (Walde)</header>

<div class="wrap">

  <div class="row">
    <div class="card mini">
      <h4>Não vai</h4>
      <div class="num" id="kpiNaoVai">0</div>
      <small class="muted">status = “Não vai” (no concurso selecionado)</small>
    </div>
    <div class="card mini">
      <h4>Pago Waldecir</h4>
      <div class="num" id="kpiWalde">0</div>
      <small class="muted">pagou_waldecir = TRUE</small>
    </div>
    <div class="card mini">
      <h4>Pago Lotérica</h4>
      <div class="num" id="kpiLoterica">0</div>
      <small class="muted">pagou_loterica = TRUE</small>
    </div>
  </div>

  <div class="card section">
    <div class="grid2">
      <div>
        <label>Selecionar concurso</label>
        <select id="selectConcurso">
          <option value="">Carregando...</option>
        </select>
        <div class="muted">Se ficar “Carregando…”: URL/chave errada, bloqueio de rede, ou projeto pausado.</div>
      </div>
      <div>
        <label>Concurso ativo</label>
        <input id="concursoAtivo" disabled value="—" />
        <div class="muted">Mostra o concurso com ativo = TRUE</div>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn gray" id="btnReload">Recarregar</button>
    </div>
    <div id="errBox" class="err" style="display:none"></div>
  </div>

  <div class="card section">
    <h3>Criar novo concurso</h3>
    <div class="grid3">
      <div>
        <label>Nome do concurso</label>
        <input id="novoNome" placeholder="Ex.: MEGA DA VIRADA" />
      </div>
      <div>
        <label>Número (opcional)</label>
        <input id="novoNumero" inputmode="numeric" placeholder="Ex.: 3457" />
      </div>
      <div>
        <label>Data</label>
        <input id="novaData" type="date" />
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
      <label style="display:flex;gap:10px;align-items:center;font-weight:800">
        <input type="checkbox" id="chkAtivo" checked />
        Marcar este como concurso ativo
      </label>
      <label style="display:flex;gap:10px;align-items:center;font-weight:800">
        <input type="checkbox" id="chkClone" checked />
        Clonar participantes do concurso selecionado (se existir)
      </label>
    </div>
    <div style="margin-top:10px">
      <button class="btn green" id="btnCriar">Criar concurso</button>
    </div>
  </div>

  <div class="card section">
    <h3>Adicionar participante ao concurso selecionado</h3>
    <div class="grid2">
      <div>
        <label>Nome do participante</label>
        <input id="novoParticipante" placeholder="Ex.: João da Silva" />
        <div class="muted">Será adicionado somente no concurso selecionado.</div>
      </div>
      <div style="display:flex;align-items:end;justify-content:flex-end">
        <button class="btn green" id="btnAddPart">Adicionar</button>
      </div>
    </div>
  </div>

  <div class="card section">
    <h3>Buscar participante (no concurso selecionado)</h3>
    <div class="searchBox">
      <div>
        <label>Buscar</label>
        <input id="busca" placeholder="Digite parte do nome… (ex.: aníbal, carlos, etc)" />
        <div class="muted">Mostra somente participantes do concurso aberto. Clique em <b>Abrir</b> para chamar o card completo.</div>
      </div>
      <button class="btn gray" id="btnLimparBusca">Limpar</button>
    </div>
    <div id="buscaResultados" class="results" style="display:none"></div>
  </div>

  <div class="card section">
    <h3>Participantes do concurso selecionado</h3>
    <div class="muted">Status muda cor automaticamente. “Remover” remove apenas deste concurso.</div>
    <div style="overflow:auto;margin-top:10px;border-radius:14px">
      <table>
        <thead>
          <tr>
            <th style="width:50px">#</th>
            <th>Nome</th>
            <th style="width:190px">Status</th>
            <th style="width:160px">Pago Waldecir</th>
            <th style="width:160px">Pago Lotérica</th>
            <th style="width:120px">Obs</th>
            <th style="width:170px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // =========================
  // CONFIG - COLE AQUI
  // =========================
  const SUPABASE_URL = "https://reudmuwpcldymuwkdszk.supabase.co"; // ex: https://xxxx.supabase.co
  const SUPABASE_KEY = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B"; // sb_publishable_...

  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

  // =========================
  // STATE
  // =========================
  let concursos = [];
  let concursoSelId = "";
  let participantes = [];
  let participantesIndex = new Map(); // id -> index
  let lastFlashId = null;

  const el = (id)=>document.getElementById(id);
  const errBox = el("errBox");
  const selectConcurso = el("selectConcurso");
  const tbody = el("tbody");

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  function normalizeStr(s){
    return (s||"")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().trim();
  }

  // =========================
  // STATUS MAP
  // =========================
  const STATUS = [
    { value:"nao_entrou", label:"Não vai", css:"statusRow-nao_entrou" },
    { value:"Pe",        label:"Prometeu", css:"statusRow-prometeu" },
    { value:"pago",      label:"Pago", css:"statusRow-pago" },
    { value:"Pc",        label:"Pago (confirmado)", css:"statusRow-pago" },
  ];

  function statusLabel(v){
    const s = STATUS.find(x=>x.value===v);
    return s ? s.label : (v||"—");
  }
  function statusCss(v){
    const s = STATUS.find(x=>x.value===v);
    return s ? s.css : "";
  }

  // =========================
  // LOAD
  // =========================
  async function loadConcursos(){
    clearErr();
    selectConcurso.innerHTML = `<option value="">Carregando...</option>`;
    el("concursoAtivo").value = "—";

    try{
      const { data, error } = await sb
        .from("concursos")
        .select("id,nome,numero,data,ativo")
        .order("created_at", { ascending:false });

      if(error) throw error;

      concursos = data || [];
      if(!concursos.length){
        selectConcurso.innerHTML = `<option value="">(nenhum concurso)</option>`;
        return;
      }

      // preenche select
      selectConcurso.innerHTML = `<option value="">Selecione...</option>` + concursos.map(c=>{
        const n = c.numero ? ` (${c.numero})` : "";
        const d = c.data ? ` – ${c.data}` : "";
        return `<option value="${c.id}">${c.nome}${n}${d}</option>`;
      }).join("");

      // concurso ativo
      const ativo = concursos.find(c=>c.ativo===true);
      el("concursoAtivo").value = ativo ? ativo.nome : "—";

      // seleciona o ativo por padrão, senão o primeiro
      const pick = ativo?.id || concursos[0].id;
      selectConcurso.value = pick;
      concursoSelId = pick;

      await loadParticipantes();

    }catch(e){
      showErr("Erro ao carregar concursos: " + (e?.message || e));
      selectConcurso.innerHTML = `<option value="">(erro)</option>`;
    }
  }

  async function loadParticipantes(){
    clearErr();
    tbody.innerHTML = "";
    participantes = [];
    participantesIndex.clear();
    lastFlashId = null;

    if(!concursoSelId){
      updateKpis();
      return;
    }

    try{
      const { data, error } = await sb
        .from("participantes")
        .select("id,nome,status,pagou_waldecir,pagou_loterica,obs,concurso_id")
        .eq("concurso_id", concursoSelId)
        .order("nome", { ascending:true });

      if(error) throw error;

      participantes = data || [];
      participantes.forEach((p, idx)=>participantesIndex.set(p.id, idx));

      renderTable();
      updateKpis();
      renderBusca(); // atualiza lista se já tiver texto digitado
    }catch(e){
      showErr("Erro ao carregar participantes: " + (e?.message || e));
      updateKpis();
    }
  }

  function updateKpis(){
    const naoVai = participantes.filter(p=>p.status==="nao_entrou").length;
    const pagoW = participantes.filter(p=>p.pagou_waldecir===true).length;
    const pagoL = participantes.filter(p=>p.pagou_loterica===true).length;
    el("kpiNaoVai").textContent = naoVai;
    el("kpiWalde").textContent = pagoW;
    el("kpiLoterica").textContent = pagoL;
  }

  // =========================
  // RENDER TABLE
  // =========================
  function makeStatusSelect(p){
    const opts = STATUS.map(s=>{
      const sel = (p.status===s.value) ? "selected" : "";
      return `<option value="${s.value}" ${sel}>${s.label}</option>`;
    }).join("");
    return `<select data-act="status" data-id="${p.id}">${opts}</select>`;
  }

  function pillBool(val){
    return val ? `<span class="pill ok">OK</span>` : `<span class="pill no">—</span>`;
  }

  function renderTable(){
    tbody.innerHTML = participantes.map((p, i)=>{
      const css = statusCss(p.status);
      const obsVal = (p.obs ?? "");
      return `
        <tr id="row-${p.id}" class="${css}">
          <td><b>${i+1}</b></td>
          <td>
            <div style="font-weight:900">${p.nome||"(sem nome)"}</div>
            <div class="tag">${p.id}</div>
          </td>
          <td>${makeStatusSelect(p)}</td>
          <td>
            <button class="btn sm green" data-act="toggleW" data-id="${p.id}">
              ${p.pagou_waldecir ? "OK" : "Marcar"}
            </button>
          </td>
          <td>
            <button class="btn sm green" data-act="toggleL" data-id="${p.id}">
              ${p.pagou_loterica ? "OK" : "Marcar"}
            </button>
          </td>
          <td>
            <input data-act="obs" data-id="${p.id}" value="${String(obsVal).replaceAll('"','&quot;')}" placeholder="" />
          </td>
          <td style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn sm blue" data-act="edit" data-id="${p.id}">Editar</button>
            <button class="btn sm red" data-act="remove" data-id="${p.id}">Remover</button>
          </td>
        </tr>
      `;
    }).join("");

    // listeners (delegation)
    tbody.querySelectorAll("select[data-act='status']").forEach(sel=>{
      sel.addEventListener("change", async (ev)=>{
        const id = ev.target.dataset.id;
        const value = ev.target.value;

        // REGRA: no ADMIN, se status virar "pago", marca pagou_waldecir = true automaticamente
        const patch = { status: value };
        if(value === "pago") patch.pagou_waldecir = true;

        await updateParticipante(id, patch, true);
      });
    });

    tbody.querySelectorAll("input[data-act='obs']").forEach(inp=>{
      let t=null;
      inp.addEventListener("input", ()=>{
        clearTimeout(t);
        t = setTimeout(async ()=>{
          const id = inp.dataset.id;
          await updateParticipante(id, { obs: inp.value ?? "" }, false);
        }, 350);
      });
    });

    tbody.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.dataset.id;
        const act = btn.dataset.act;

        if(act==="toggleW"){
          const p = participantes[participantesIndex.get(id)];
          await updateParticipante(id, { pagou_waldecir: !p.pagou_waldecir }, true);
        }

        if(act==="toggleL"){
          const p = participantes[participantesIndex.get(id)];
          await updateParticipante(id, { pagou_loterica: !p.pagou_loterica }, true);
        }

        if(act==="edit"){
          const p = participantes[participantesIndex.get(id)];
          const novoNome = prompt("Editar nome do participante:", p.nome || "");
          if(novoNome===null) return;
          const nome = novoNome.trim();
          if(!nome) return alert("Nome inválido.");
          await updateParticipante(id, { nome }, true);
        }

        if(act==="remove"){
          if(!confirm("Remover este participante APENAS deste concurso?")) return;
          await removerParticipante(id);
        }
      });
    });
  }

  async function updateParticipante(id, patch, reloadAll){
    clearErr();
    try{
      const { error } = await sb.from("participantes").update(patch).eq("id", id);
      if(error) throw error;

      // atualiza local sem depender de reload completo
      const idx = participantesIndex.get(id);
      if(idx!==undefined){
        participantes[idx] = { ...participantes[idx], ...patch };
      }

      if(reloadAll){
        // re-render para refletir cor/status/botões e KPI
        renderTable();
        updateKpis();
        renderBusca();
      }else{
        updateKpis();
      }
    }catch(e){
      showErr("Erro ao salvar: " + (e?.message || e));
    }
  }

  async function removerParticipante(id){
    clearErr();
    try{
      const { error } = await sb.from("participantes").delete().eq("id", id);
      if(error) throw error;

      participantes = participantes.filter(p=>p.id!==id);
      participantesIndex.clear();
      participantes.forEach((p, idx)=>participantesIndex.set(p.id, idx));

      renderTable();
      updateKpis();
      renderBusca();
    }catch(e){
      showErr("Erro ao remover: " + (e?.message || e));
    }
  }

  // =========================
  // BUSCA + ABRIR CARD
  // =========================
  const busca = el("busca");
  const buscaResultados = el("buscaResultados");

  function renderBusca(){
    const q = normalizeStr(busca.value);
    if(!q){
      buscaResultados.style.display = "none";
      buscaResultados.innerHTML = "";
      return;
    }

    const matches = participantes
      .filter(p => normalizeStr(p.nome).includes(q) || normalizeStr(p.obs).includes(q))
      .slice(0, 30);

    if(!matches.length){
      buscaResultados.style.display = "block";
      buscaResultados.innerHTML = `<div class="resItem"><div><div class="resName">Nenhum resultado</div><div class="resMeta">Tente outro termo.</div></div></div>`;
      return;
    }

    buscaResultados.style.display = "block";
    buscaResultados.innerHTML = matches.map(p=>{
      return `
        <div class="resItem">
          <div>
            <div class="resName">${p.nome}</div>
            <div class="resMeta">Status: ${statusLabel(p.status)} • Obs: ${p.obs ?? ""}</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn sm blue" data-open="${p.id}">Abrir</button>
          </div>
        </div>
      `;
    }).join("");

    buscaResultados.querySelectorAll("button[data-open]").forEach(b=>{
      b.addEventListener("click", ()=>{
        openCard(b.dataset.open);
      });
    });
  }

  function openCard(id){
    const row = document.getElementById("row-"+id);
    if(!row) return;

    if(lastFlashId){
      const prev = document.getElementById("row-"+lastFlashId);
      if(prev) prev.classList.remove("flash");
    }
    lastFlashId = id;

    row.scrollIntoView({ behavior:"smooth", block:"center" });
    row.classList.add("flash");
    setTimeout(()=>row.classList.remove("flash"), 1800);
  }

  busca.addEventListener("input", ()=>renderBusca());
  el("btnLimparBusca").addEventListener("click", ()=>{
    busca.value = "";
    renderBusca();
  });

  // =========================
  // ACTIONS
  // =========================
  selectConcurso.addEventListener("change", async ()=>{
    concursoSelId = selectConcurso.value || "";
    await loadParticipantes();
  });

  el("btnReload").addEventListener("click", async ()=>{
    await loadConcursos();
  });

  el("btnAddPart").addEventListener("click", async ()=>{
    clearErr();
    const nome = (el("novoParticipante").value || "").trim();
    if(!concursoSelId) return alert("Selecione um concurso primeiro.");
    if(!nome) return alert("Digite o nome do participante.");

    try{
      const payload = {
        nome,
        concurso_id: concursoSelId,
        status: "Pe", // padrão: Prometeu
        pagou_waldecir: false,
        pagou_loterica: false,
        obs: ""
      };
      const { error } = await sb.from("participantes").insert(payload);
      if(error) throw error;

      el("novoParticipante").value = "";
      await loadParticipantes();
    }catch(e){
      showErr("Erro ao adicionar participante: " + (e?.message || e));
    }
  });

  el("btnCriar").addEventListener("click", async ()=>{
    clearErr();
    const nome = (el("novoNome").value || "").trim();
    const numeroTxt = (el("novoNumero").value || "").trim();
    const data = el("novaData").value || null;
    const ativo = el("chkAtivo").checked;
    const clonar = el("chkClone").checked;

    if(!nome) return alert("Digite o nome do concurso.");

    const numero = numeroTxt ? Number(numeroTxt) : null;
    if(numeroTxt && Number.isNaN(numero)) return alert("Número inválido.");

    try{
      // se marcar ativo, desativa os outros
      if(ativo){
        const { error: e0 } = await sb.from("concursos").update({ ativo:false }).neq("id", "00000000-0000-0000-0000-000000000000");
        if(e0) throw e0;
      }

      const { data: inserted, error } = await sb
        .from("concursos")
        .insert({ nome, numero, data, ativo })
        .select("id")
        .single();

      if(error) throw error;

      const novoId = inserted.id;

      // clonar participantes do concurso selecionado
      if(clonar && concursoSelId){
        const { data: src, error: e1 } = await sb
          .from("participantes")
          .select("nome,status,pagou_waldecir,pagou_loterica,obs")
          .eq("concurso_id", concursoSelId);

        if(e1) throw e1;

        if((src||[]).length){
          const clones = src.map(p=>({
            nome: p.nome,
            status: p.status ?? "Pe",
            pagou_waldecir: false,
            pagou_loterica: false,
            obs: p.obs ?? "",
            concurso_id: novoId
          }));
          const { error: e2 } = await sb.from("participantes").insert(clones);
          if(e2) throw e2;
        }
      }

      // limpa form
      el("novoNome").value = "";
      el("novoNumero").value = "";
      el("novaData").value = "";

      await loadConcursos();
      selectConcurso.value = novoId;
      concursoSelId = novoId;
      await loadParticipantes();

    }catch(e){
      showErr("Erro ao criar concurso: " + (e?.message || e));
    }
  });

  // =========================
  // INIT
  // =========================
  (async function init(){
    // validações simples (evita “Failed to fetch” por URL vazia)
    if(!SUPABASE_URL || !SUPABASE_KEY || SUPABASE_URL.startsWith("COLE_") || SUPABASE_KEY.startsWith("COLE_")){
      showErr("Configure SUPABASE_URL e SUPABASE_KEY (publishable) no topo do arquivo.");
      selectConcurso.innerHTML = `<option value="">(configure URL/Key)</option>`;
      return;
    }
    await loadConcursos();
  })();
</script>
</body>
</html>


