<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bolão – Admin / Waldecir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --verde-header: #2e7d32;
      --verde-ok: #4caf50;
      --amarelo: #fff9c4;
      --cinza-claro: #eeeeee;
      --borda: #e0e0e0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    header {
      background: var(--verde-header);
      color: #fff;
      padding: 12px 16px;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px;
    }

    .box {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      margin-bottom: 10px;
    }

    .box h3 {
      margin: 0 0 8px;
      font-size: 15px;
    }

    .linha {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
    }

    select,
    input[type="text"],
    input[type="date"] {
      font-size: 13px;
      padding: 5px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 100%;
      max-width: 100%;
    }

    button {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
    }

    button.primario {
      background: var(--verde-header);
      color: #fff;
      border-color: #1b5e20;
    }

    button.primario:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    button.ctrl {
      font-size: 11px;
      padding: 3px 6px;
    }

    button.ativo {
      background: var(--verde-ok);
      color: #fff;
      border-color: #388e3c;
      font-weight: 600;
    }

    .resumo {
      font-size: 13px;
    }

    .resumo div {
      margin-bottom: 2px;
    }

    .resumo strong {
      display: inline-block;
      min-width: 140px;
    }

    .status-msg {
      font-size: 12px;
      margin-top: 4px;
    }

    .status-msg.status-erro {
      color: #c62828;
    }

    .status-msg.status-ok {
      color: #2e7d32;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
    }

    thead {
      background: #ffeb3b;
    }

    th, td {
      padding: 5px 4px;
      border-bottom: 1px solid var(--borda);
      text-align: left;
    }

    th:nth-child(1),
    td:nth-child(1) {
      width: 40px;
      text-align: center;
    }

    th:nth-child(4),
    th:nth-child(5) {
      text-align: center;
      width: 110px;
    }

    th:nth-child(3) {
      width: 130px;
    }

    tbody tr:nth-child(even) {
      background: #fafafa;
    }

    tr.pago {
      background: #c8e6c9 !important;
    }

    tr.prometeu {
      background: var(--amarelo) !important;
    }

    tr.nao-entrou {
      background: var(--cinza-claro) !important;
    }

    .obs-input {
      width: 100%;
      font-size: 11px;
      padding: 3px 4px;
    }

    @media (max-width: 720px) {
      header {
        font-size: 16px;
      }
      th, td {
        padding: 4px 3px;
      }
    }
  </style>
</head>
<body>
  <header>Bolão – Painel Admin / Waldecir</header>

  <div class="container">

    <!-- Seleção de concurso -->
    <div class="box">
      <div class="linha">
        <div style="flex: 1 1 250px;">
          <label for="selectConcurso">Concurso</label>
          <select id="selectConcurso"></select>
        </div>
        <div style="flex: 1 1 160px;">
          <label>Concurso ativo</label>
          <div id="textoConcursoAtivo" style="font-size:13px;font-weight:600;">Nenhum selecionado</div>
        </div>
      </div>
      <div id="statusCarregando" class="status-msg"></div>
      <div id="statusConcurso" class="status-msg"></div>
    </div>

    <!-- Resumo -->
    <div class="box">
      <h3>Resumo do concurso selecionado</h3>
      <div class="resumo">
        <div><strong>Total de participantes:</strong> <span id="totalNomes">0</span></div>
        <div><strong>Pagos (qualquer forma):</strong> <span id="totalPagos">0</span></div>
        <div><strong>Prometeram:</strong> <span id="totalPrometeram">0</span></div>
        <div><strong>Não entraram:</strong> <span id="totalNaoEntraram">0</span></div>
      </div>
    </div>

    <!-- Novo participante -->
    <div class="box">
      <h3>Adicionar participante ao concurso selecionado</h3>
      <form id="formNovo" class="linha">
        <input
          type="text"
          id="nomeNovo"
          placeholder="Nome do participante"
          required
          style="flex:1 1 220px;"
        />
        <button type="submit" class="primario" id="btnAdd">Adicionar</button>
      </form>
      <div class="status-msg" id="statusNovo"></div>
      <small style="font-size:11px;color:#555;">
        Obs: o participante é vinculado ao <strong>concurso selecionado</strong> acima.
      </small>
    </div>

    <!-- Tabela -->
    <div class="box">
      <h3>Participantes</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Nome</th>
            <th>Status</th>
            <th>Pagou Waldecir</th>
            <th>Pagou Lotérica</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="tabela"></tbody>
      </table>
    </div>

  </div>

  <script>
    // ================== CONFIG SUPABASE ==================
    const { createClient } = supabase;
    const supabaseUrl = "https://redmuwpcldymuwkdszk.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJldWRtdXdwY2xkeW11d2tkc3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNzI4NzYsImV4cCI6MjA4MDg0ODg3Nn0.TvwzRrz6Vp4ZjqucroS8Ui6dV5AJLPPweOJz4XimJrU";

    const sb = createClient(supabaseUrl, supabaseKey);

    // ================== ESTADO ==================
    let concursos = [];
    let participantes = [];
    let concursoSelecionadoId = null;

    const selectConcurso = document.getElementById("selectConcurso");
    const textoConcursoAtivo = document.getElementById("textoConcursoAtivo");
    const statusCarregando = document.getElementById("statusCarregando");
    const statusConcurso = document.getElementById("statusConcurso");
    const tabela = document.getElementById("tabela");

    const totalNomesEl = document.getElementById("totalNomes");
    const totalPagosEl = document.getElementById("totalPagos");
    const totalPrometeramEl = document.getElementById("totalPrometeram");
    const totalNaoEntraramEl = document.getElementById("totalNaoEntraram");

    const formNovo = document.getElementById("formNovo");
    const nomeNovoEl = document.getElementById("nomeNovo");
    const statusNovoEl = document.getElementById("statusNovo");
    const btnAdd = document.getElementById("btnAdd");

    function msg(el, texto, tipo = "ok", tempo = 3000) {
      el.textContent = texto;
      el.className = "status-msg " + (tipo === "erro" ? "status-erro" : "status-ok");
      if (tempo) {
        setTimeout(() => {
          el.textContent = "";
        }, tempo);
      }
    }

    // ================== CARREGAR CONCURSOS ==================
    async function carregarConcursos() {
      statusCarregando.textContent = "Carregando concursos...";
      try {
        const { data, error } = await sb
          .from("concursos")
          .select("*")
          .order("data", { ascending: false })
          .order("created_at", { ascending: false });

        if (error) throw error;

        concursos = data || [];
        selectConcurso.innerHTML = "";

        if (concursos.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "Nenhum concurso cadastrado";
          selectConcurso.appendChild(opt);
          concursoSelecionadoId = null;
          textoConcursoAtivo.textContent = "Nenhum selecionado";
          participantes = [];
          renderTabela();
          atualizarResumo();
          statusCarregando.textContent = "";
          return;
        }

        concursos.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c.id;
          const dt = c.data ? new Date(c.data).toLocaleDateString("pt-BR") : "";
          opt.textContent = `${c.nome} ${dt ? " - " + dt : ""}`;
          selectConcurso.appendChild(opt);
        });

        // seleciona o primeiro
        concursoSelecionadoId = concursos[0].id;
        atualizarTextoConcurso();
        await carregarParticipantes();
        statusCarregando.textContent = "";
      } catch (e) {
        statusCarregando.textContent = "Erro ao carregar concursos: " + e.message;
      }
    }

    function atualizarTextoConcurso() {
      const c = concursos.find((x) => x.id === concursoSelecionadoId);
      if (!c) {
        textoConcursoAtivo.textContent = "Nenhum selecionado";
        return;
      }
      const dt = c.data ? new Date(c.data).toLocaleDateString("pt-BR") : "";
      textoConcursoAtivo.textContent = `${c.nome} ${dt ? "- " + dt : ""}`;
    }

    // ================== CARREGAR PARTICIPANTES ==================
    async function carregarParticipantes() {
      if (!concursoSelecionadoId) {
        participantes = [];
        renderTabela();
        atualizarResumo();
        return;
      }
      statusConcurso.textContent = "Carregando participantes...";
      try {
        const { data, error } = await sb
          .from("participantes")
          .select("*")
          .eq("concurso_id", concursoSelecionadoId);

        if (error) throw error;
        participantes = data || [];
        renderTabela();
        atualizarResumo();
        statusConcurso.textContent = "";
      } catch (e) {
        statusConcurso.textContent = "Erro ao carregar participantes: " + e.message;
      }
    }

    // ================== RESUMO ==================
    function atualizarResumo() {
      const total = participantes.length;
      let pagos = 0, prom = 0, nao = 0;

      participantes.forEach((p) => {
        let status = p.status || "nao_entrou";
        if (p.pagou_waldecir || p.pagou_loterica) status = "pago";
        if (status === "pago") pagos++;
        else if (status === "prometeu") prom++;
        else nao++;
      });

      totalNomesEl.textContent = total;
      totalPagosEl.textContent = pagos;
      totalPrometeramEl.textContent = prom;
      totalNaoEntraramEl.textContent = nao;
    }

    function aplicarClasseLinha(tr, p) {
      tr.classList.remove("pago", "prometeu", "nao-entrou");
      let status = p.status || "nao_entrou";
      if (p.pagou_waldecir || p.pagou_loterica) status = "pago";
      if (status === "pago") tr.classList.add("pago");
      else if (status === "prometeu") tr.classList.add("prometeu");
      else tr.classList.add("nao-entrou");
    }

    // ================== RENDER TABELA ==================
    function renderTabela() {
      tabela.innerHTML = "";

      const ordenados = [...participantes].sort((a, b) =>
        (a.nome || "").localeCompare(b.nome || "", "pt-BR")
      );

      ordenados.forEach((p, idx) => {
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = idx + 1;

        const tdNome = document.createElement("td");
        tdNome.textContent = p.nome || "";

        const tdStatus = document.createElement("td");
        const sel = document.createElement("select");
        [
          ["nao_entrou", "Não entrou"],
          ["prometeu", "Prometeu"],
          ["pago", "Pago"]
        ].forEach(([v, l]) => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = l;
          sel.appendChild(o);
        });
        sel.value = p.status || "nao_entrou";
        tdStatus.appendChild(sel);

        const tdWal = document.createElement("td");
        tdWal.style.textAlign = "center";
        const btnWal = document.createElement("button");
        btnWal.className = "ctrl";
        btnWal.textContent = "OK Waldecir";
        if (p.pagou_waldecir) btnWal.classList.add("ativo");
        tdWal.appendChild(btnWal);

        const tdLot = document.createElement("td");
        tdLot.style.textAlign = "center";
        const btnLot = document.createElement("button");
        btnLot.className = "ctrl";
        btnLot.textContent = "OK Lotérica";
        if (p.pagou_loterica) btnLot.classList.add("ativo");
        tdLot.appendChild(btnLot);

        const tdObs = document.createElement("td");
        const inpObs = document.createElement("input");
        inpObs.type = "text";
        inpObs.className = "obs-input";
        inpObs.placeholder = "Obs";
        inpObs.value = p.obs || "";
        tdObs.appendChild(inpObs);

        tr.appendChild(tdIdx);
        tr.appendChild(tdNome);
        tr.appendChild(tdStatus);
        tr.appendChild(tdWal);
        tr.appendChild(tdLot);
        tr.appendChild(tdObs);

        aplicarClasseLinha(tr, p);
        tabela.appendChild(tr);

        // Eventos
        sel.addEventListener("change", async () => {
          const novo = sel.value;
          try {
            await sb.from("participantes").update({ status: novo }).eq("id", p.id);
            p.status = novo;
            aplicarClasseLinha(tr, p);
            atualizarResumo();
          } catch (e) {
            alert("Erro ao atualizar status: " + e.message);
            sel.value = p.status || "nao_entrou";
          }
        });

        btnWal.addEventListener("click", async () => {
          const novo = !p.pagou_waldecir;
          btnWal.disabled = true;
          try {
            await sb
              .from("participantes")
              .update({ pagou_waldecir: novo })
              .eq("id", p.id);
            p.pagou_waldecir = novo;
            if (novo) btnWal.classList.add("ativo");
            else btnWal.classList.remove("ativo");
            aplicarClasseLinha(tr, p);
            atualizarResumo();
          } catch (e) {
            alert("Erro ao atualizar pagamento Waldecir: " + e.message);
          } finally {
            btnWal.disabled = false;
          }
        });

        btnLot.addEventListener("click", async () => {
          const novo = !p.pagou_loterica;
          btnLot.disabled = true;
          try {
            await sb
              .from("participantes")
              .update({ pagou_loterica: novo })
              .eq("id", p.id);
            p.pagou_loterica = novo;
            if (novo) btnLot.classList.add("ativo");
            else btnLot.classList.remove("ativo");
            aplicarClasseLinha(tr, p);
            atualizarResumo();
          } catch (e) {
            alert("Erro ao atualizar pagamento lotérica: " + e.message);
          } finally {
            btnLot.disabled = false;
          }
        });

        inpObs.addEventListener("change", async () => {
          const novo = inpObs.value;
          try {
            await sb
              .from("participantes")
              .update({ obs: novo })
              .eq("id", p.id);
            p.obs = novo;
          } catch (e) {
            alert("Erro ao salvar observação: " + e.message);
          }
        });
      });
    }

    // ================== NOVO PARTICIPANTE ==================
    formNovo.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!concursoSelecionadoId) {
        msg(statusNovoEl, "Selecione um concurso primeiro.", "erro");
        return;
      }
      const nome = nomeNovoEl.value.trim();
      if (!nome) return;

      btnAdd.disabled = true;
      try {
        const { data, error } = await sb
          .from("participantes")
          .insert({
            nome,
            concurso_id: concursoSelecionadoId,
            status: "nao_entrou",
            pagou_waldecir: false,
            pagou_loterica: false
          })
          .select("*")
          .single();

        if (error) throw error;

        participantes.push(data);
        renderTabela();
        atualizarResumo();
        nomeNovoEl.value = "";
        msg(statusNovoEl, "Participante adicionado com sucesso.");
      } catch (e) {
        msg(statusNovoEl, "Erro ao adicionar: " + e.message, "erro", 5000);
      } finally {
        btnAdd.disabled = false;
      }
    });

    // ================== TROCA DE CONCURSO ==================
    selectConcurso.addEventListener("change", async () => {
      concursoSelecionadoId = selectConcurso.value || null;
      atualizarTextoConcurso();
      await carregarParticipantes();
    });

    // ================== INICIALIZAÇÃO ==================
    (async function init() {
      await carregarConcursos();
    })();
  </script>
</body>
</html>
