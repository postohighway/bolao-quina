<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel do Admin (Walde)</title>

  <style>
    :root{
      --green:#1f6f3a;
      --green2:#2e8b57;
      --yellow:#ffefb5;
      --red:#ffe2e2;
      --gray:#f3f4f6;
      --header:#2f7d32;
      --amber:#f5b301;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:linear-gradient(#eef2f7,#f6f7fb); color:#111}
    .topbar{background:var(--header); color:#fff; padding:14px 18px; font-weight:800; text-align:center; position:sticky; top:0; z-index:10}
    .wrap{max-width:1200px; margin:18px auto; padding:0 14px}
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:14px}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 6px 0; font-size:14px; color:#444; font-weight:800}
    .big{font-size:40px; font-weight:900; line-height:1}
    .sub{color:#666; font-size:12px}

    .section{margin-top:14px}
    .section h2{margin:0 0 8px 0; font-size:22px}
    .panel{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow); padding:14px}
    label{display:block;font-size:12px;color:#444;font-weight:800;margin:8px 0 6px}
    input, select, button{font-size:16px}
    input, select{width:100%; padding:10px 12px;border:1px solid #d8dbe2;border-radius:10px;background:#fff;outline:none}
    input:focus, select:focus{border-color:#7bbf87; box-shadow:0 0 0 3px rgba(31,111,58,.15)}
    .row{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; align-items:end}
    .row2{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:end}
    .checks{display:flex; gap:14px; flex-wrap:wrap; margin-top:10px}
    .checks label{display:flex; align-items:center; gap:8px; margin:0; font-weight:700}
    .checks input{width:auto}
    .btn{border:0; border-radius:12px; padding:12px 16px; font-weight:900; cursor:pointer}
    .btn-green{background:var(--green); color:#fff}
    .btn-blue{background:#1673d1; color:#fff}
    .btn-red{background:#d62828; color:#fff}
    .btn-gray{background:#6b7280; color:#fff}
    .btn:active{transform:translateY(1px)}
    .hint{color:#666;font-size:12px; margin-top:8px}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; display:none}
    .ok{background:#e8fff0;color:#0b5a22;border:1px solid #b7f3cb}
    .err{background:#ffecec;color:#9b1c1c;border:1px solid #ffc2c2}

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; margin-top:12px}
    thead th{background:var(--amber); color:#111; font-weight:900; text-align:left; padding:12px}
    tbody td{padding:10px 12px; border-bottom:1px solid #eee; vertical-align:middle}
    tbody tr:last-child td{border-bottom:0}
    tbody tr.base{background:#fff}
    tbody tr.prometeu{background:var(--yellow)}
    tbody tr.pago{background:#e9f8ea}
    tbody tr.nao_vai{background:var(--red)}

    .pill{display:inline-block; min-width:44px; text-align:center; padding:8px 12px; border-radius:10px; font-weight:900}
    .pill-ok{background:var(--green2); color:#fff}
    .pill-off{background:#e5e7eb; color:#111}
    .tiny{font-size:12px;color:#555}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .idline{font-size:12px; color:#666; margin-top:6px}

    @media(max-width:900px){
      .grid3{grid-template-columns:1fr; }
      .row{grid-template-columns:1fr;}
    }
  </style>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="topbar">Bolão – Painel do Admin (Walde)</div>

  <div class="wrap">

    <div class="grid3">
      <div class="card">
        <h3>Não vai</h3>
        <div class="big" id="kpiNaoVai">0</div>
        <div class="sub">status = “Não vai” (no concurso selecionado)</div>
      </div>
      <div class="card">
        <h3>Pago Waldecir</h3>
        <div class="big" id="kpiPagoW">0</div>
        <div class="sub">pagou_waldecir = TRUE</div>
      </div>
      <div class="card">
        <h3>Pago Lotérica</h3>
        <div class="big" id="kpiPagoL">0</div>
        <div class="sub">pagou_loterica = TRUE</div>
      </div>
    </div>

    <div class="section panel" style="margin-top:14px">
      <div class="row2">
        <div>
          <label>Selecionar concurso</label>
          <select id="selectConcurso"></select>
          <div class="hint">Se ficar “Carregando…”: URL/chave errada, bloqueio de rede, ou projeto pausado.</div>
        </div>
        <div style="min-width:220px">
          <label>Concurso ativo</label>
          <input id="txtConcursoAtivo" disabled placeholder="—" />
        </div>
        <div style="align-self:end; justify-self:end">
          <button class="btn btn-gray" id="btnReload">Recarregar</button>
        </div>
      </div>

      <div class="msg ok" id="msgOk"></div>
      <div class="msg err" id="msgErr"></div>
    </div>

    <div class="section panel">
      <h2>Criar novo concurso</h2>
      <div class="row">
        <div>
          <label>Nome do concurso</label>
          <input id="novoNome" placeholder="Ex.: MEGA DA VIRADA" />
        </div>
        <div>
          <label>Número (opcional)</label>
          <input id="novoNumero" type="number" placeholder="Ex.: 3457" />
        </div>
        <div>
          <label>Data</label>
          <input id="novaData" type="date" />
        </div>
      </div>

      <div class="checks">
        <label><input type="checkbox" id="chkAtivo" checked /> Marcar este como concurso ativo</label>
        <label><input type="checkbox" id="chkClonar" checked /> Clonar participantes do concurso selecionado (se existir)</label>
      </div>

      <div style="margin-top:12px">
        <button class="btn btn-green" id="btnCriar">Criar concurso</button>
      </div>
    </div>

    <div class="section panel">
      <h2>Adicionar participante ao concurso selecionado</h2>
      <div class="row2">
        <div>
          <label>Nome do participante</label>
          <input id="novoParticipanteNome" placeholder="Ex.: João da Silva" />
          <div class="hint">Será adicionado somente no concurso selecionado.</div>
        </div>
        <div style="align-self:end">
          <button class="btn btn-green" id="btnAddParticipante">Adicionar</button>
        </div>
      </div>
    </div>

    <div class="section panel">
      <h2>Participantes do concurso selecionado</h2>
      <div class="hint">Status muda a cor. “Pagou” (no Admin) marca automaticamente <b>pagou_waldecir = TRUE</b> para somar no topo.</div>

      <table>
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>Nome</th>
            <th style="width:170px">Status</th>
            <th style="width:170px">Pago Waldecir</th>
            <th style="width:170px">Pago Lotérica</th>
            <th style="width:120px">Obs</th>
            <th style="width:190px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

<script>
/** =========================
 *  CONFIG – PREENCHA AQUI
 *  ========================= */
const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";
const SUPABASE_KEY = "SUA_PUBLISHABLE_KEY_AQUI";

/** =========================
 *  SUPABASE CLIENT
 *  ========================= */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: { persistSession: false }
});

/** =========================
 *  ELEMENTOS
 *  ========================= */
const el = (id)=>document.getElementById(id);
const selectConcurso = el("selectConcurso");
const txtConcursoAtivo = el("txtConcursoAtivo");
const tbody = el("tbody");
const msgOk = el("msgOk");
const msgErr = el("msgErr");

const kpiNaoVai = el("kpiNaoVai");
const kpiPagoW = el("kpiPagoW");
const kpiPagoL = el("kpiPagoL");

/** =========================
 *  HELPERS UI
 *  ========================= */
function showOk(text){ msgOk.textContent = text; msgOk.style.display="block"; msgErr.style.display="none"; }
function showErr(text){ msgErr.textContent = text; msgErr.style.display="block"; msgOk.style.display="none"; }
function clearMsg(){ msgOk.style.display="none"; msgErr.style.display="none"; }

function normStatus(dbStatus){
  const s = (dbStatus || "").toString().trim().toLowerCase();
  // antigos -> novo padrão
  if (s === "nao_entrou") return "nao_vai";
  if (s === "pc" || s === "pe" || s === "prometeu") return "prometeu";
  if (s === "pago" || s === "pagou") return "pago";
  if (s === "nao_vai" || s === "não vai") return "nao_vai";
  return "nao_vai"; // default seguro
}
function labelStatus(canon){
  if (canon === "nao_vai") return "Não vai";
  if (canon === "prometeu") return "Prometeu";
  return "Pagou";
}
function rowClassByStatus(canon){
  if (canon === "nao_vai") return "nao_vai";
  if (canon === "prometeu") return "prometeu";
  if (canon === "pago") return "pago";
  return "base";
}

/** =========================
 *  STATE
 *  ========================= */
let concursos = [];
let participantes = [];
let concursoSelecionadoId = null;

/** =========================
 *  LOAD CONCURSOS
 *  ========================= */
async function loadConcursos(){
  clearMsg();
  selectConcurso.innerHTML = `<option value="">Carregando...</option>`;
  try{
    const { data, error } = await sb
      .from("concursos")
      .select("id, nome, numero, data, ativo, created_at")
      .order("created_at", { ascending:false });

    if (error) throw error;

    concursos = data || [];

    if (concursos.length === 0){
      selectConcurso.innerHTML = `<option value="">(sem concursos)</option>`;
      txtConcursoAtivo.value = "—";
      concursoSelecionadoId = null;
      participantes = [];
      render();
      return;
    }

    // concurso ativo
    const ativo = concursos.find(c => c.ativo === true);
    txtConcursoAtivo.value = ativo ? (ativo.nome || "—") : "—";

    // preencher select
    selectConcurso.innerHTML = concursos.map(c=>{
      const n = c.numero ? ` (${c.numero})` : " ()";
      return `<option value="${c.id}">${c.nome}${n}</option>`;
    }).join("");

    // manter seleção se possível
    if (!concursoSelecionadoId || !concursos.some(c=>c.id===concursoSelecionadoId)){
      concursoSelecionadoId = concursos[0].id;
    }
    selectConcurso.value = concursoSelecionadoId;

    await loadParticipantes();
  }catch(e){
    showErr("Erro ao carregar concursos: " + (e?.message || e));
    selectConcurso.innerHTML = `<option value="">(erro)</option>`;
  }
}

/** =========================
 *  LOAD PARTICIPANTES
 *  ========================= */
async function loadParticipantes(){
  if (!concursoSelecionadoId){
    participantes = [];
    render();
    return;
  }
  clearMsg();
  try{
    const { data, error } = await sb
      .from("participantes")
      .select("id, nome, status, pagou_waldecir, pagou_loterica, obs, concurso_id, created_at")
      .eq("concurso_id", concursoSelecionadoId)
      .order("nome", { ascending:true });

    if (error) throw error;

    participantes = (data || []).map(p => ({
      ...p,
      status_canon: normStatus(p.status)
    }));

    render();
  }catch(e){
    showErr("Erro ao carregar participantes: " + (e?.message || e));
    participantes = [];
    render();
  }
}

/** =========================
 *  RENDER
 *  ========================= */
function render(){
  // KPI
  const naoVai = participantes.filter(p => p.status_canon === "nao_vai").length;
  const pagoW = participantes.filter(p => p.pagou_waldecir === true).length;
  const pagoL = participantes.filter(p => p.pagou_loterica === true).length;

  kpiNaoVai.textContent = naoVai;
  kpiPagoW.textContent = pagoW;
  kpiPagoL.textContent = pagoL;

  // tabela
  if (participantes.length === 0){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:16px;color:#666">Nenhum participante neste concurso.</td></tr>`;
    return;
  }

  tbody.innerHTML = participantes.map((p, idx)=>{
    const cls = rowClassByStatus(p.status_canon);
    const obsVal = (p.obs ?? "").toString();

    const btnW = p.pagou_waldecir ? `<span class="pill pill-ok">OK</span>` : `<button class="btn btn-green" style="padding:10px 14px" data-act="toggleW" data-id="${p.id}">Marcar</button>`;
    const btnL = p.pagou_loterica ? `<span class="pill pill-ok">OK</span>` : `<button class="btn btn-green" style="padding:10px 14px" data-act="toggleL" data-id="${p.id}">Marcar</button>`;

    return `
      <tr class="${cls}">
        <td>${idx+1}</td>
        <td>
          <div style="font-weight:900">${escapeHtml(p.nome || "")}</div>
          <div class="idline">${p.id}</div>
        </td>

        <td>
          <select data-act="status" data-id="${p.id}">
            <option value="nao_vai" ${p.status_canon==="nao_vai"?"selected":""}>Não vai</option>
            <option value="prometeu" ${p.status_canon==="prometeu"?"selected":""}>Prometeu</option>
            <option value="pago" ${p.status_canon==="pago"?"selected":""}>Pagou</option>
          </select>
        </td>

        <td>${btnW}</td>
        <td>${btnL}</td>

        <td>
          <input data-act="obs" data-id="${p.id}" value="${escapeAttr(obsVal)}" placeholder="" />
        </td>

        <td>
          <div class="actions">
            <button class="btn btn-blue" style="padding:10px 14px" data-act="edit" data-id="${p.id}">Editar</button>
            <button class="btn btn-red"  style="padding:10px 14px" data-act="remove" data-id="${p.id}">Remover</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");
}

function escapeHtml(s){
  return (s??"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s); }

/** =========================
 *  ACTIONS
 *  ========================= */
selectConcurso.addEventListener("change", async ()=>{
  concursoSelecionadoId = selectConcurso.value || null;
  await loadParticipantes();
});

el("btnReload").addEventListener("click", async ()=>{
  await loadConcursos();
});

el("btnCriar").addEventListener("click", async ()=>{
  clearMsg();

  const nome = el("novoNome").value.trim();
  const numeroRaw = el("novoNumero").value.trim();
  const data = el("novaData").value || null;
  const ativo = el("chkAtivo").checked;
  const clonar = el("chkClonar").checked;

  if (!nome) return showErr("Digite o nome do concurso.");

  const numero = numeroRaw ? Number(numeroRaw) : null;
  if (numeroRaw && Number.isNaN(numero)) return showErr("Número inválido.");

  try{
    // se marcar ativo, desmarca outros
    if (ativo){
      const { error: errUp } = await sb.from("concursos").update({ ativo:false }).eq("ativo", true);
      if (errUp) throw errUp;
    }

    const payload = { nome, numero, data, ativo };
    const { data: inserted, error } = await sb.from("concursos").insert(payload).select("id").single();
    if (error) throw error;

    const novoId = inserted.id;

    // clonar participantes do concurso atual selecionado
    if (clonar && concursoSelecionadoId){
      const { data: origem, error: errOrigem } = await sb
        .from("participantes")
        .select("nome, status, pagou_waldecir, pagou_loterica, obs")
        .eq("concurso_id", concursoSelecionadoId);

      if (errOrigem) throw errOrigem;

      const rows = (origem || []).map(p => ({
        nome: p.nome,
        status: normStatus(p.status),
        pagou_waldecir: false,
        pagou_loterica: false,
        obs: p.obs ?? "",
        concurso_id: novoId
      }));

      if (rows.length){
        const { error: errIns } = await sb.from("participantes").insert(rows);
        if (errIns) throw errIns;
      }
    }

    showOk("Concurso criado com sucesso.");
    // reset form
    el("novoNome").value = "";
    el("novoNumero").value = "";
    el("novaData").value = "";
    // recarregar e selecionar o novo
    concursoSelecionadoId = novoId;
    await loadConcursos();
    selectConcurso.value = novoId;
    await loadParticipantes();
  }catch(e){
    showErr("Erro ao criar concurso: " + (e?.message || e));
  }
});

el("btnAddParticipante").addEventListener("click", async ()=>{
  clearMsg();
  const nome = el("novoParticipanteNome").value.trim();
  if (!concursoSelecionadoId) return showErr("Selecione um concurso.");
  if (!nome) return showErr("Digite o nome do participante.");

  try{
    const payload = {
      nome,
      status: "nao_vai",
      pagou_waldecir: false,
      pagou_loterica: false,
      obs: "",
      concurso_id: concursoSelecionadoId
    };
    const { error } = await sb.from("participantes").insert(payload);
    if (error) throw error;

    el("novoParticipanteNome").value = "";
    showOk("Participante adicionado.");
    await loadParticipantes();
  }catch(e){
    showErr("Erro ao adicionar participante: " + (e?.message || e));
  }
});

// delegação de eventos da tabela
tbody.addEventListener("click", async (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if (!btn) return;
  const act = btn.getAttribute("data-act");
  const id = btn.getAttribute("data-id");
  if (!act || !id) return;

  const p = participantes.find(x=>x.id===id);
  if (!p) return;

  try{
    if (act === "toggleW"){
      const { error } = await sb.from("participantes").update({ pagou_waldecir:true }).eq("id", id);
      if (error) throw error;
      await loadParticipantes();
      return;
    }
    if (act === "toggleL"){
      const { error } = await sb.from("participantes").update({ pagou_loterica:true }).eq("id", id);
      if (error) throw error;
      await loadParticipantes();
      return;
    }
    if (act === "remove"){
      if (!confirm("Excluir da chamada (somente deste concurso)?")) return;
      const { error } = await sb.from("participantes").delete().eq("id", id);
      if (error) throw error;
      await loadParticipantes();
      showOk("Removido deste concurso.");
      return;
    }
    if (act === "edit"){
      const novoNome = prompt("Editar nome do participante:", p.nome || "");
      if (novoNome === null) return;
      const nome = novoNome.trim();
      if (!nome) return showErr("Nome não pode ficar vazio.");
      const { error } = await sb.from("participantes").update({ nome }).eq("id", id);
      if (error) throw error;
      await loadParticipantes();
      showOk("Nome atualizado.");
      return;
    }
  }catch(e){
    showErr("Erro: " + (e?.message || e));
  }
});

tbody.addEventListener("change", async (ev)=>{
  const target = ev.target;
  const act = target.getAttribute("data-act");
  const id = target.getAttribute("data-id");
  if (!act || !id) return;

  const p = participantes.find(x=>x.id===id);
  if (!p) return;

  try{
    if (act === "status"){
      const canon = target.value; // nao_vai | prometeu | pago

      // REGRA PEDIDA: ao escolher "Pagou" no ADMIN, marca pagou_waldecir automaticamente
      const patch = { status: canon };
      if (canon === "pago"){
        patch.pagou_waldecir = true;
      }

      const { error } = await sb.from("participantes").update(patch).eq("id", id);
      if (error) throw error;
      await loadParticipantes();
      return;
    }

    if (act === "obs"){
      const obs = target.value ?? "";
      const { error } = await sb.from("participantes").update({ obs }).eq("id", id);
      if (error) throw error;
      // não precisa recarregar tudo, mas pra manter simples:
      await loadParticipantes();
      return;
    }
  }catch(e){
    showErr("Erro: " + (e?.message || e));
  }
});

/** =========================
 *  INIT
 *  ========================= */
(async function init(){
  // valida URL/chave
  if (!SUPABASE_URL.includes("supabase.co") || SUPABASE_KEY.length < 20){
    showErr("Configure SUPABASE_URL e SUPABASE_KEY no topo do arquivo.");
    selectConcurso.innerHTML = `<option value="">(configure URL/Key)</option>`;
    return;
  }
  await loadConcursos();
})();
</script>

</body>
</html>
