<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel do Admin (Walde)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --green:#2e7d32;
      --green2:#1b5e20;
      --card:#ffffff;
      --bg:#f3f5f7;
      --muted:#6b7280;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{background:var(--green2);color:#fff;padding:16px 20px;font-weight:800;text-align:center;font-size:22px}
    .wrap{max-width:1200px;margin:16px auto;padding:0 14px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .kpi{flex:1;min-width:220px}
    .kpi .t{color:#111827;font-weight:800;font-size:18px}
    .kpi .n{font-size:44px;font-weight:900;margin-top:4px}
    .kpi .s{color:var(--muted);font-size:13px;margin-top:4px}
    h2{margin:18px 0 10px}
    label{display:block;font-weight:700;margin:10px 0 6px}
    input,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:15px;background:#fff}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-green{background:var(--green2);color:#fff}
    .btn-gray{background:#6b7280;color:#fff}
    .btn-blue{background:#1976d2;color:#fff}
    .btn-red{background:#d32f2f;color:#fff}
    .btn-sm{padding:8px 12px;border-radius:10px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .err{background:#ffe4e6;border:1px solid #fecdd3;color:#9f1239;padding:10px;border-radius:12px;margin-top:10px;font-weight:700}
    .ok{background:#dcfce7;border:1px solid #86efac;color:#14532d;padding:10px;border-radius:12px;margin-top:10px;font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;box-shadow:var(--shadow);background:#fff}
    thead th{background:#f6b100;color:#111827;text-align:left;padding:12px;font-weight:900}
    tbody td{padding:10px;border-top:1px solid #eef2f7;vertical-align:middle}
    tbody tr:nth-child(even){background:#f8fbff}
    .name{font-weight:900}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .pill{display:inline-block;padding:6px 10px;border-radius:10px;font-weight:900;font-size:13px}
    .pill-ok{background:#1f7a2a;color:#fff}
    .pill-no{background:#e5e7eb;color:#111827}
    .obs{width:80px;text-align:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .rowStatus-nao_entrou{background:#ffe7e7 !important}
    .rowStatus-Pe{background:#fff7cc !important}
    .rowStatus-Pc{background:#e6f4ff !important}
    .rowStatus-pago{background:#e7f7ea !important}
    @media (max-width:900px){
      .grid2,.grid3{grid-template-columns:1fr}
      .actions{justify-content:flex-start}
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody td{border-top:0;border-bottom:1px solid #eef2f7}
      tbody tr{margin-bottom:10px;border-radius:14px;overflow:hidden}
      tbody td::before{content:attr(data-label);display:block;font-weight:900;color:#111827;margin-bottom:4px}
      .obs{width:100%}
    }
  </style>
</head>
<body>
<header>Bolão – Painel do Admin (Walde)</header>

<div class="wrap">
  <div class="row">
    <div class="card kpi">
      <div class="t">Não vai</div>
      <div class="n" id="kpiNaoVai">0</div>
      <div class="s">status = “nao_entrou” (no concurso selecionado)</div>
    </div>
    <div class="card kpi">
      <div class="t">Pago Waldecir</div>
      <div class="n" id="kpiWalde">0</div>
      <div class="s">pagou_waldecir = TRUE</div>
    </div>
    <div class="card kpi">
      <div class="t">Pago Lotérica</div>
      <div class="n" id="kpiLoterica">0</div>
      <div class="s">pagou_loterica = TRUE</div>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="grid2">
      <div>
        <label>Selecionar concurso</label>
        <select id="selConcurso"></select>
        <div class="muted" style="margin-top:6px">
          Se ficar “Carregando...”: URL/chave errada, bloqueio de rede, ou RLS/policies não permitindo SELECT.
        </div>
      </div>
      <div>
        <label>Concurso ativo</label>
        <input id="inpAtivo" disabled placeholder="—" />
        <div class="muted" style="margin-top:6px">Mostra o concurso com <b>ativo = TRUE</b></div>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
      <button class="btn btn-gray" id="btnReload">Recarregar</button>
    </div>
    <div id="msg"></div>
  </div>

  <div class="card" style="margin-top:14px">
    <h2 style="margin-top:0">Criar novo concurso</h2>
    <div class="grid3">
      <div>
        <label>Nome do concurso</label>
        <input id="newNome" placeholder="Ex.: MEGA DA VIRADA" />
      </div>
      <div>
        <label>Número (opcional)</label>
        <input id="newNumero" placeholder="Ex.: 3457" />
      </div>
      <div>
        <label>Data</label>
        <input id="newData" type="date" />
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:16px;flex-wrap:wrap;align-items:center">
      <label style="display:flex;gap:10px;align-items:center;margin:0">
        <input type="checkbox" id="chkAtivo" checked style="width:auto" />
        Marcar este como concurso ativo
      </label>
      <label style="display:flex;gap:10px;align-items:center;margin:0">
        <input type="checkbox" id="chkClonar" checked style="width:auto" />
        Clonar participantes do concurso selecionado (se existir)
      </label>
    </div>

    <div style="margin-top:12px">
      <button class="btn btn-green" id="btnCriar">Criar concurso</button>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <h2 style="margin-top:0">Adicionar participante ao concurso selecionado</h2>
    <label>Nome do participante</label>
    <div class="grid2">
      <input id="addNome" placeholder="Ex.: João da Silva" />
      <button class="btn btn-green" id="btnAdd">Adicionar</button>
    </div>
    <div class="muted" style="margin-top:6px">Será adicionado somente no concurso selecionado.</div>
  </div>

  <div style="margin-top:14px">
    <h2>Participantes do concurso selecionado</h2>
    <div class="muted" style="margin-bottom:10px">
      Status muda a cor. “Pago” (no Admin) marca automaticamente <b>pagou_waldecir = TRUE</b> para somar no topo.
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>Nome</th>
          <th style="width:170px">Status</th>
          <th style="width:150px">Pago Waldecir</th>
          <th style="width:150px">Pago Lotérica</th>
          <th style="width:90px">Obs</th>
          <th style="width:170px;text-align:right">Ações</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<script>
  // ========= CONFIG =========
  const SUPABASE_URL = "https://reudmuwpcldymuwkdszk.supabase.co";
  const SUPABASE_KEY = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B"; // publishable

  // ========= HELPERS =========
  const $ = (id) => document.getElementById(id);
  const msg = (type, text) => {
    $("msg").innerHTML = `<div class="${type}">${text}</div>`;
  };
  const clearMsg = () => $("msg").innerHTML = "";

  function validateSupabase(){
    if (!SUPABASE_URL || !SUPABASE_URL.includes("supabase.co")) {
      msg("err","Configure SUPABASE_URL corretamente (tem que terminar com .supabase.co).");
      return false;
    }
    if (!SUPABASE_KEY || !SUPABASE_KEY.startsWith("sb_publishable_")) {
      msg("err","A SUPABASE_KEY precisa ser a <b>Publishable key</b> (começa com sb_publishable_). Não use secret/service_role.");
      return false;
    }
    return true;
  }

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let concursos = [];
  let concursoSelId = null;
  let participantes = [];

  // ========= QUERIES =========
  async function loadConcursos(){
    clearMsg();
    $("selConcurso").innerHTML = `<option value="">Carregando...</option>`;
    const { data, error } = await sb
      .from("concursos")
      .select("id,nome,numero,data,ativo,created_at")
      .order("created_at", { ascending:false });

    if (error) throw error;

    concursos = data || [];
    if (!concursos.length){
      $("selConcurso").innerHTML = `<option value="">(sem concursos)</option>`;
      concursoSelId = null;
      $("inpAtivo").value = "";
      return;
    }

    const ativo = concursos.find(c => c.ativo === true);
    $("inpAtivo").value = ativo ? ativo.nome : "—";

    // mantém seleção se possível
    if (!concursoSelId) concursoSelId = ativo?.id || concursos[0].id;

    $("selConcurso").innerHTML = concursos.map(c => {
      const label = `${c.nome}${c.numero ? " ("+c.numero+")" : ""}`;
      return `<option value="${c.id}" ${c.id===concursoSelId ? "selected":""}>${label}</option>`;
    }).join("");

    await loadParticipantes();
    await loadResumo();
  }

  async function loadParticipantes(){
    if (!concursoSelId){
      $("tb").innerHTML = "";
      participantes = [];
      return;
    }
    const { data, error } = await sb
      .from("participantes")
      .select("id,nome,status,pagou_waldecir,pagou_loterica,obs,created_at,concurso_id")
      .eq("concurso_id", concursoSelId)
      .order("created_at", { ascending:true });

    if (error) throw error;
    participantes = data || [];
    renderTable();
  }

  async function loadResumo(){
    if (!concursoSelId){
      $("kpiNaoVai").textContent = "0";
      $("kpiWalde").textContent = "0";
      $("kpiLoterica").textContent = "0";
      return;
    }
    // Não vai
    const { count: cNao, error: e1 } = await sb
      .from("participantes")
      .select("*", { count:"exact", head:true })
      .eq("concurso_id", concursoSelId)
      .eq("status", "nao_entrou");
    if (e1) throw e1;

    // Pago Waldecir
    const { count: cW, error: e2 } = await sb
      .from("participantes")
      .select("*", { count:"exact", head:true })
      .eq("concurso_id", concursoSelId)
      .eq("pagou_waldecir", true);
    if (e2) throw e2;

    // Pago Lotérica
    const { count: cL, error: e3 } = await sb
      .from("participantes")
      .select("*", { count:"exact", head:true })
      .eq("concurso_id", concursoSelId)
      .eq("pagou_loterica", true);
    if (e3) throw e3;

    $("kpiNaoVai").textContent = String(cNao || 0);
    $("kpiWalde").textContent = String(cW || 0);
    $("kpiLoterica").textContent = String(cL || 0);
  }

  // ========= RENDER =========
  function statusLabel(v){
    switch(v){
      case "nao_entrou": return "Não vai";
      case "Pe": return "Prometeu";
      case "Pc": return "Confirmado";
      case "pago": return "Pago";
      default: return "Prometeu";
    }
  }

  function renderTable(){
    $("tb").innerHTML = participantes.map((p, idx) => {
      const st = p.status || "Pe";
      return `
        <tr class="rowStatus-${st}">
          <td data-label="#" style="font-weight:900">${idx+1}</td>
          <td data-label="Nome">
            <div class="name">${escapeHtml(p.nome || "")}</div>
            <div class="sub">${p.id}</div>
          </td>

          <td data-label="Status">
            <select data-act="status" data-id="${p.id}">
              <option value="nao_entrou" ${st==="nao_entrou"?"selected":""}>Não vai</option>
              <option value="Pe" ${st==="Pe"?"selected":""}>Prometeu</option>
              <option value="Pc" ${st==="Pc"?"selected":""}>Confirmado</option>
              <option value="pago" ${st==="pago"?"selected":""}>Pago</option>
            </select>
          </td>

          <td data-label="Pago Waldecir">
            ${p.pagou_waldecir ? `<span class="pill pill-ok">OK</span>` : `<button class="btn btn-sm btn-gray" data-act="walde" data-id="${p.id}">Marcar</button>`}
          </td>

          <td data-label="Pago Lotérica">
            ${p.pagou_loterica ? `<span class="pill pill-ok">OK</span>` : `<button class="btn btn-sm btn-gray" data-act="loterica" data-id="${p.id}">Marcar</button>`}
          </td>

          <td data-label="Obs">
            <input class="obs" data-act="obs" data-id="${p.id}" value="${escapeAttr(p.obs || "")}" />
          </td>

          <td data-label="Ações" style="text-align:right">
            <div class="actions">
              <button class="btn btn-sm btn-blue" data-act="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-sm btn-red" data-act="remove" data-id="${p.id}">Remover</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    // delegação de eventos
    $("tb").querySelectorAll("[data-act]").forEach(el => {
      const act = el.getAttribute("data-act");
      if (act === "status") {
        el.addEventListener("change", onAction);
      } else if (act === "obs") {
        el.addEventListener("change", onAction);
      } else {
        el.addEventListener("click", onAction);
      }
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

  // ========= ACTIONS =========
  async function onAction(ev){
    const el = ev.currentTarget;
    const act = el.getAttribute("data-act");
    const id = el.getAttribute("data-id");
    const p = participantes.find(x => x.id === id);
    if (!p) return;

    try{
      clearMsg();

      if (act === "status"){
        const canon = el.value; // nao_entrou | Pe | Pc | pago

        // regra: se virar "pago" no ADMIN => pagou_waldecir = true
        const patch = {
          status: canon,
          pagou_waldecir: (canon === "pago")
        };

        const { error } = await sb.from("participantes").update(patch).eq("id", id);
        if (error) throw error;

        await loadParticipantes();
        await loadResumo();
        return;
      }

      if (act === "obs"){
        const obs = el.value ?? "";
        const { error } = await sb.from("participantes").update({ obs }).eq("id", id);
        if (error) throw error;
        await loadParticipantes();
        return;
      }

      if (act === "walde"){
        const { error } = await sb.from("participantes").update({ pagou_waldecir:true }).eq("id", id);
        if (error) throw error;
        await loadParticipantes();
        await loadResumo();
        return;
      }

      if (act === "loterica"){
        const { error } = await sb.from("participantes").update({ pagou_loterica:true }).eq("id", id);
        if (error) throw error;
        await loadParticipantes();
        await loadResumo();
        return;
      }

      if (act === "edit"){
        const novo = prompt("Editar nome do participante:", p.nome || "");
        if (novo === null) return;
        const nome = (novo || "").trim();
        if (!nome) return msg("err","Nome não pode ficar vazio.");
        const { error } = await sb.from("participantes").update({ nome }).eq("id", id);
        if (error) throw error;
        await loadParticipantes();
        return;
      }

      if (act === "remove"){
        const ok = confirm("Excluir este participante SOMENTE deste concurso?");
        if (!ok) return;
        const { error } = await sb.from("participantes").delete().eq("id", id);
        if (error) throw error;
        await loadParticipantes();
        await loadResumo();
        return;
      }

    }catch(e){
      msg("err","Erro: " + (e?.message || e));
      console.error(e);
    }
  }

  async function criarConcurso(){
    const nome = ($("newNome").value || "").trim();
    const numeroRaw = ($("newNumero").value || "").trim();
    const data = $("newData").value || null;
    const marcarAtivo = $("chkAtivo").checked;
    const clonar = $("chkClonar").checked;

    if (!nome) return msg("err","Informe o nome do concurso.");

    const numero = numeroRaw ? Number(numeroRaw) : null;
    if (numeroRaw && Number.isNaN(numero)) return msg("err","Número inválido.");

    try{
      clearMsg();

      if (marcarAtivo){
        // desativa todos
        const { error: e0 } = await sb.from("concursos").update({ ativo:false }).neq("id", "00000000-0000-0000-0000-000000000000");
        if (e0) throw e0;
      }

      const payload = { nome, numero, data, ativo: !!marcarAtivo };
      const { data: inserted, error } = await sb.from("concursos").insert(payload).select("id").single();
      if (error) throw error;

      const novoId = inserted.id;

      if (clonar && concursoSelId){
        // clona participantes do concurso selecionado
        const { data: base, error: e1 } = await sb
          .from("participantes")
          .select("nome,status,obs")
          .eq("concurso_id", concursoSelId);

        if (e1) throw e1;

        if (base?.length){
          const rows = base.map(x => ({
            concurso_id: novoId,
            nome: x.nome,
            status: x.status || "Pe",
            obs: x.obs || "",
            pagou_waldecir: false,
            pagou_loterica: false
          }));
          const { error: e2 } = await sb.from("participantes").insert(rows);
          if (e2) throw e2;
        }
      }

      $("newNome").value = "";
      $("newNumero").value = "";
      $("newData").value = "";
      msg("ok","Concurso criado com sucesso!");

      concursoSelId = novoId;
      await loadConcursos();

    }catch(e){
      msg("err","Erro ao criar concurso: " + (e?.message || e));
      console.error(e);
    }
  }

  async function addParticipante(){
    const nome = ($("addNome").value || "").trim();
    if (!concursoSelId) return msg("err","Selecione um concurso.");
    if (!nome) return msg("err","Informe o nome do participante.");

    try{
      clearMsg();
      const row = {
        concurso_id: concursoSelId,
        nome,
        status: "Pe",
        pagou_waldecir: false,
        pagou_loterica: false,
        obs: ""
      };
      const { error } = await sb.from("participantes").insert(row);
      if (error) throw error;

      $("addNome").value = "";
      await loadParticipantes();
      await loadResumo();

    }catch(e){
      msg("err","Erro ao adicionar: " + (e?.message || e));
      console.error(e);
    }
  }

  // ========= INIT =========
  (async function init(){
    try{
      if (!validateSupabase()) return;
      $("btnReload").addEventListener("click", () => loadConcursos().catch(err => msg("err","Erro ao carregar concursos: " + (err?.message||err))));
      $("selConcurso").addEventListener("change", async () => {
        concursoSelId = $("selConcurso").value || null;
        await loadParticipantes();
        await loadResumo();
      });
      $("btnCriar").addEventListener("click", criarConcurso);
      $("btnAdd").addEventListener("click", addParticipante);

      await loadConcursos();

    }catch(e){
      msg("err","Erro ao carregar concursos: " + (e?.message || e));
      console.error(e);
    }
  })();
</script>
</body>
</html>
