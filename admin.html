<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel do Admin (Walde)</title>

  <!-- iPhone "app" icon (opcional) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Bolão Admin" />

  <style>
    :root{
      --green:#2e7d32;
      --green2:#1b5e20;
      --orange:#f2b705;
      --red:#c62828;
      --gray:#f3f4f6;
      --line:#e5e7eb;
      --txt:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --shadow:0 8px 24px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
      color:var(--txt);
      background:#f6f7fb;
    }
    header{
      background:var(--green);
      color:#fff;
      padding:14px 16px;
      font-weight:800;
      text-align:center;
      font-size:20px;
    }
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .grid3{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      margin-bottom:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .kpi-title{color:var(--muted);font-weight:700}
    .kpi-val{font-size:34px;font-weight:900;margin-top:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{font-weight:700}
    input,select,button,textarea{
      font:inherit;
      border:1px solid #cfd4dc;
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
    button{cursor:pointer;border:none}
    .btn{
      padding:10px 12px;
      border-radius:10px;
      font-weight:800;
      color:#fff;
    }
    .btn-green{background:var(--green)}
    .btn-green:hover{background:var(--green2)}
    .btn-blue{background:#1976d2}
    .btn-blue:hover{background:#155fb0}
    .btn-red{background:#d32f2f}
    .btn-red:hover{background:#b71c1c}
    .btn-gray{background:#6b7280}
    .btn-gray:hover{background:#4b5563}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .err{color:#b91c1c;font-weight:800;margin-top:8px}
    .ok{color:#166534;font-weight:800;margin-top:8px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
    }
    thead th{
      background:var(--orange);
      color:#111;
      text-align:left;
      padding:12px 10px;
      font-weight:900;
      border-bottom:1px solid #d9a500;
      font-size:14px;
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    tbody tr:last-child td{border-bottom:none}

    /* STATUS CORES (linha inteira) */
    tr.st-nao_vai{background:#fde8e8}
    tr.st-prometeu{background:#fff7d1}
    tr.st-pagou{background:#e8f7ea}

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid rgba(0,0,0,.08);
    }
    .pill-ok{background:var(--green);color:#fff}
    .pill-no{background:#e5e7eb;color:#111}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .w-100{width:100%}

    @media (max-width:820px){
      .grid3{grid-template-columns:1fr; }
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{border-bottom:1px solid var(--line)}
      tbody td{border:none;border-bottom:1px dashed #e5e7eb}
      tbody td:last-child{border-bottom:none}
      tbody td::before{
        content:attr(data-label);
        display:block;
        font-size:12px;
        color:var(--muted);
        font-weight:800;
        margin-bottom:4px;
      }
    }
  </style>

  <!-- Supabase JS (UMD) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
<header>Bolão – Painel do Admin (Walde)</header>

<div class="wrap">

  <div class="grid3">
    <div class="card">
      <div class="kpi-title">Não vai</div>
      <div class="kpi-val" id="kpiNaoVai">0</div>
      <div class="small">Participantes marcados como “Não vai” no concurso selecionado</div>
    </div>
    <div class="card">
      <div class="kpi-title">Pago Waldecir</div>
      <div class="kpi-val" id="kpiPagoW">0</div>
      <div class="small">pagou_waldecir = TRUE</div>
    </div>
    <div class="card">
      <div class="kpi-title">Pago Lotérica</div>
      <div class="kpi-val" id="kpiPagoL">0</div>
      <div class="small">pagou_loterica = TRUE</div>
    </div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div class="row">
      <div style="flex:1;min-width:260px;">
        <label for="selectConcurso">Selecionar concurso</label><br/>
        <select id="selectConcurso" class="w-100"></select>
        <div class="hint">Se estiver “Carregando…” pra sempre, é chave/URL errada ou bloqueio de rede.</div>
      </div>
      <div style="flex:1;min-width:260px;">
        <label>Concurso ativo</label><br/>
        <input id="txtAtivo" class="w-100" disabled />
        <div class="hint">Mostra o concurso com ativo = TRUE</div>
      </div>
      <div style="flex:0;min-width:180px;align-self:flex-end;">
        <button class="btn btn-gray w-100" id="btnRecarregar">Recarregar</button>
      </div>
    </div>

    <div id="msgTop"></div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <h3 style="margin:0 0 10px 0;">Criar novo concurso</h3>
    <div class="row">
      <div style="flex:2;min-width:240px;">
        <label>Nome do concurso</label><br/>
        <input id="novoNome" class="w-100" placeholder="Ex.: MEGA DA VIRADA" />
      </div>
      <div style="flex:1;min-width:180px;">
        <label>Número (opcional)</label><br/>
        <input id="novoNumero" class="w-100" placeholder="Ex.: 3457" />
      </div>
      <div style="flex:1;min-width:200px;">
        <label>Data</label><br/>
        <input id="novoData" type="date" class="w-100" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <label style="display:flex;gap:8px;align-items:center;">
        <input type="checkbox" id="chkAtivo" checked />
        Marcar este como concurso ativo
      </label>
      <label style="display:flex;gap:8px;align-items:center;">
        <input type="checkbox" id="chkClonar" checked />
        Clonar participantes do último concurso ativo (se existir)
      </label>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-green" id="btnCriar">Criar concurso</button>
      <div id="msgCriar"></div>
    </div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <h3 style="margin:0 0 10px 0;">Adicionar participante ao concurso selecionado</h3>
    <div class="row">
      <div style="flex:1;min-width:240px;">
        <label>Nome do participante</label><br/>
        <input id="novoParticipanteNome" class="w-100" placeholder="Ex.: João da Silva" />
        <div class="hint">Será adicionado somente no concurso selecionado.</div>
      </div>
      <div style="flex:0;min-width:180px;align-self:flex-end;">
        <button class="btn btn-green w-100" id="btnAddParticipante">Adicionar</button>
      </div>
    </div>
    <div id="msgAdd"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;">Participantes do concurso selecionado</h3>
    <div class="hint">Status muda cor automaticamente. “Remover” remove apenas deste concurso.</div>
    <div style="margin-top:10px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:50px;">#</th>
            <th>Nome</th>
            <th style="width:160px;">Status</th>
            <th style="width:140px;">Pago Waldecir</th>
            <th style="width:140px;">Pago Lotérica</th>
            <th style="width:120px;">Obs</th>
            <th style="width:170px;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  /***********************
   * CONFIG SUPABASE
   ***********************/
  const supabaseUrl = "https://reudmuwpcldymuwkdszk.supabase.co";
  const supabaseKey = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B"; // sua publishable key
  const sb = supabase.createClient(supabaseUrl, supabaseKey);

  /***********************
   * ESTADO
   ***********************/
  let concursos = [];
  let concursoSelecionadoId = null;

  const elSelectConcurso = document.getElementById("selectConcurso");
  const elTxtAtivo = document.getElementById("txtAtivo");
  const elTbody = document.getElementById("tbody");
  const elMsgTop = document.getElementById("msgTop");
  const elKpiNaoVai = document.getElementById("kpiNaoVai");
  const elKpiPagoW = document.getElementById("kpiPagoW");
  const elKpiPagoL = document.getElementById("kpiPagoL");

  function msg(el, texto, ok=false){
    el.innerHTML = texto ? `<div class="${ok?'ok':'err'}">${texto}</div>` : "";
  }

  function statusLabel(v){
    if(v==="nao_vai") return "Não vai";
    if(v==="prometeu") return "Prometeu";
    if(v==="pagou") return "Pagou";
    return "—";
  }

  function rowClassByStatus(v){
    if(v==="nao_vai") return "st-nao_vai";
    if(v==="prometeu") return "st-prometeu";
    if(v==="pagou") return "st-pagou";
    return "";
  }

  async function carregarConcursos(){
    msg(elMsgTop, "");
    elSelectConcurso.innerHTML = `<option value="">Carregando...</option>`;
    try{
      const { data, error } = await sb
        .from("concursos")
        .select("id,nome,numero,data,ativo,created_at")
        .order("created_at", { ascending:false });

      if(error) throw error;
      concursos = data || [];

      if(concursos.length===0){
        elSelectConcurso.innerHTML = `<option value="">(Nenhum concurso)</option>`;
        elTxtAtivo.value = "";
        concursoSelecionadoId = null;
        elTbody.innerHTML = "";
        atualizarKPIs([]);
        return;
      }

      // concurso ativo
      const ativo = concursos.find(c => c.ativo) || null;
      elTxtAtivo.value = ativo ? `${ativo.nome}${ativo.numero ? " ("+ativo.numero+")" : ""}` : "-";

      // popular select
      elSelectConcurso.innerHTML = concursos.map(c=>{
        const label = `${c.nome}${c.numero ? " ("+c.numero+")" : ""}`;
        return `<option value="${c.id}">${label}</option>`;
      }).join("");

      // manter seleção anterior se existir
      if(concursoSelecionadoId && concursos.some(c=>c.id===concursoSelecionadoId)){
        elSelectConcurso.value = concursoSelecionadoId;
      }else{
        concursoSelecionadoId = concursos[0].id;
        elSelectConcurso.value = concursoSelecionadoId;
      }

      await carregarParticipantes();
    }catch(e){
      msg(elMsgTop, `Erro ao carregar concursos: ${e.message || e}`);
      elSelectConcurso.innerHTML = `<option value="">(Erro)</option>`;
    }
  }

  function atualizarKPIs(participantes){
    const naoVai = participantes.filter(p => p.status === "nao_vai").length;
    const pagoW = participantes.filter(p => p.pagou_waldecir === true).length;
    const pagoL = participantes.filter(p => p.pagou_loterica === true).length;
    elKpiNaoVai.textContent = naoVai;
    elKpiPagoW.textContent = pagoW;
    elKpiPagoL.textContent = pagoL;
  }

  async function carregarParticipantes(){
    if(!concursoSelecionadoId){
      elTbody.innerHTML = "";
      atualizarKPIs([]);
      return;
    }
    try{
      const { data, error } = await sb
        .from("participantes")
        .select("id,concurso_id,nome,status,pagou_waldecir,pagou_loterica,obs,created_at")
        .eq("concurso_id", concursoSelecionadoId)
        .order("nome", { ascending:true });

      if(error) throw error;

      const participantes = data || [];
      atualizarKPIs(participantes);
      renderTabela(participantes);
    }catch(e){
      msg(elMsgTop, `Erro ao carregar participantes: ${e.message || e}`);
      elTbody.innerHTML = "";
      atualizarKPIs([]);
    }
  }

  function renderTabela(participantes){
    elTbody.innerHTML = "";

    participantes.forEach((p, idx)=>{
      const tr = document.createElement("tr");
      tr.className = rowClassByStatus(p.status);

      tr.innerHTML = `
        <td data-label="#" style="font-weight:900;">${idx+1}</td>

        <td data-label="Nome">
          <div style="font-weight:900;">${escapeHtml(p.nome || "")}</div>
          <div class="small">${p.id}</div>
        </td>

        <td data-label="Status">
          <select data-action="status" data-id="${p.id}">
            <option value="nao_vai" ${p.status==="nao_vai"?"selected":""}>Não vai</option>
            <option value="prometeu" ${p.status==="prometeu"?"selected":""}>Prometeu</option>
            <option value="pagou" ${p.status==="pagou"?"selected":""}>Pagou</option>
          </select>
        </td>

        <td data-label="Pago Waldecir">
          ${p.pagou_waldecir
            ? `<span class="pill pill-ok">OK</span> <button class="btn btn-gray" data-action="toggleW" data-id="${p.id}">Desmarcar</button>`
            : `<span class="pill pill-no">—</span> <button class="btn btn-green" data-action="toggleW" data-id="${p.id}">Marcar</button>`
          }
        </td>

        <td data-label="Pago Lotérica">
          ${p.pagou_loterica
            ? `<span class="pill pill-ok">OK</span> <button class="btn btn-gray" data-action="toggleL" data-id="${p.id}">Desmarcar</button>`
            : `<span class="pill pill-no">—</span> <button class="btn btn-green" data-action="toggleL" data-id="${p.id}">Marcar</button>`
          }
        </td>

        <td data-label="Obs">
          <input value="${escapeAttr(p.obs || "")}" data-action="obs" data-id="${p.id}" style="width:90px;" />
        </td>

        <td data-label="Ações">
          <div class="actions">
            <button class="btn btn-blue" data-action="editar" data-id="${p.id}" data-nome="${escapeAttr(p.nome||"")}">Editar</button>
            <button class="btn btn-red" data-action="remover" data-id="${p.id}" data-nome="${escapeAttr(p.nome||"")}">Remover</button>
          </div>
        </td>
      `;

      elTbody.appendChild(tr);
    });

    // handlers
    elTbody.querySelectorAll("[data-action='status']").forEach(sel=>{
      sel.addEventListener("change", async (ev)=>{
        const id = ev.target.getAttribute("data-id");
        const novo = ev.target.value;
        await atualizarCampo(id, { status: novo });
      });
    });

    elTbody.querySelectorAll("[data-action='obs']").forEach(inp=>{
      inp.addEventListener("change", async (ev)=>{
        const id = ev.target.getAttribute("data-id");
        const obs = ev.target.value;
        await atualizarCampo(id, { obs });
      });
    });

    elTbody.querySelectorAll("[data-action='toggleW']").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const atual = btn.textContent.includes("Desmarcar");
        await atualizarCampo(id, { pagou_waldecir: !atual });
      });
    });

    elTbody.querySelectorAll("[data-action='toggleL']").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const atual = btn.textContent.includes("Desmarcar");
        await atualizarCampo(id, { pagou_loterica: !atual });
      });
    });

    elTbody.querySelectorAll("[data-action='editar']").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const nomeAtual = btn.getAttribute("data-nome");
        const novoNome = prompt("Editar nome do participante:", nomeAtual);
        if(novoNome === null) return;
        const nomeTrim = novoNome.trim();
        if(!nomeTrim){ alert("Nome vazio."); return; }
        await atualizarCampo(id, { nome: nomeTrim });
      });
    });

    elTbody.querySelectorAll("[data-action='remover']").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const nome = btn.getAttribute("data-nome");
        const ok = confirm(`Remover "${nome}" SOMENTE deste concurso?`);
        if(!ok) return;
        await removerParticipante(id);
      });
    });
  }

  async function atualizarCampo(id, patch){
    try{
      const { error } = await sb
        .from("participantes")
        .update(patch)
        .eq("id", id);

      if(error) throw error;
      await carregarParticipantes();
    }catch(e){
      alert(`Falha ao salvar: ${e.message || e}`);
    }
  }

  async function removerParticipante(id){
    try{
      const { error } = await sb
        .from("participantes")
        .delete()
        .eq("id", id);  // DELETE POR ID (o certo)

      if(error) throw error;
      await carregarParticipantes();
    }catch(e){
      alert(`Falha ao remover: ${e.message || e}`);
    }
  }

  async function criarConcurso(){
    const nome = document.getElementById("novoNome").value.trim();
    const numero = document.getElementById("novoNumero").value.trim();
    const data = document.getElementById("novoData").value;
    const ativo = document.getElementById("chkAtivo").checked;
    const clonar = document.getElementById("chkClonar").checked;
    const elMsg = document.getElementById("msgCriar");

    msg(elMsg, "");
    if(!nome){ msg(elMsg, "Informe o nome do concurso."); return; }
    if(!data){ msg(elMsg, "Informe a data."); return; }

    try{
      // se vai marcar ativo, desativa os outros
      if(ativo){
        const { error: e1 } = await sb.from("concursos").update({ ativo:false }).eq("ativo", true);
        if(e1) throw e1;
      }

      const payload = { nome, data, ativo };
      // numero pode ser null
      payload.numero = numero ? numero : null;

      const { data: novo, error } = await sb.from("concursos").insert(payload).select("id").single();
      if(error) throw error;

      // clonar do último concurso ativo anterior (antes de desativar) não dá pra saber fácil,
      // então clonamos do MAIS RECENTE concurso que tenha participantes (ou do anterior ativo se existir).
      if(clonar){
        // tenta pegar concurso ativo mais recente (exceto o novo)
        const { data: antigos, error: e2 } = await sb
          .from("concursos")
          .select("id,ativo,created_at")
          .neq("id", novo.id)
          .order("ativo", { ascending:false })
          .order("created_at", { ascending:false })
          .limit(5);

        if(e2) throw e2;

        const candidato = (antigos || []).find(x=>x.ativo) || (antigos || [])[0] || null;

        if(candidato){
          const { data: partOld, error: e3 } = await sb
            .from("participantes")
            .select("nome,status,pagou_waldecir,pagou_loterica,obs")
            .eq("concurso_id", candidato.id);

          if(e3) throw e3;

          if((partOld||[]).length){
            const clones = partOld.map(p=>({
              concurso_id: novo.id,
              nome: p.nome,
              status: "prometeu",           // ao clonar, volta pra "Prometeu" por padrão
              pagou_waldecir: false,
              pagou_loterica: false,
              obs: p.obs || null
            }));

            const { error: e4 } = await sb.from("participantes").insert(clones);
            if(e4) throw e4;
          }
        }
      }

      msg(elMsg, "Concurso criado com sucesso!", true);
      document.getElementById("novoNome").value = "";
      document.getElementById("novoNumero").value = "";
      document.getElementById("novoData").value = "";

      await carregarConcursos();
    }catch(e){
      msg(elMsg, `Erro ao criar concurso: ${e.message || e}`);
    }
  }

  async function addParticipante(){
    const nome = document.getElementById("novoParticipanteNome").value.trim();
    const elMsg = document.getElementById("msgAdd");
    msg(elMsg, "");

    if(!concursoSelecionadoId){ msg(elMsg, "Selecione um concurso."); return; }
    if(!nome){ msg(elMsg, "Digite um nome."); return; }

    try{
      const payload = {
        concurso_id: concursoSelecionadoId,
        nome,
        status: "prometeu",
        pagou_waldecir: false,
        pagou_loterica: false,
        obs: null
      };

      const { error } = await sb.from("participantes").insert(payload);
      if(error) throw error;

      msg(elMsg, "Participante adicionado!", true);
      document.getElementById("novoParticipanteNome").value = "";
      await carregarParticipantes();
    }catch(e){
      msg(elMsg, `Erro ao adicionar: ${e.message || e}`);
    }
  }

  // helpers anti XSS
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function escapeAttr(s){
    return escapeHtml(s).replace(/"/g,'&quot;');
  }

  // eventos
  document.getElementById("btnRecarregar").addEventListener("click", carregarConcursos);
  document.getElementById("btnCriar").addEventListener("click", criarConcurso);
  document.getElementById("btnAddParticipante").addEventListener("click", addParticipante);

  elSelectConcurso.addEventListener("change", async ()=>{
    concursoSelecionadoId = elSelectConcurso.value || null;
    await carregarParticipantes();
  });

  // init
  carregarConcursos();
</script>

</body>
</html>
