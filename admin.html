<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bol√£o ‚Äì Painel do Admin (Waldecir)</title>

  <style>
    :root {
      --verde-header: #1b5e20;
      --verde-botao: #2e7d32;
      --verde-botao-hover: #1b5e20;
      --vermelho: #d32f2f;
      --cinza-claro: #f5f5f5;
      --borda-caixa: #ddd;
    }

    * {
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      margin: 0;
      background: #fafafa;
    }

    header {
      background: var(--verde-header);
      color: #fff;
      padding: 12px 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    main {
      max-width: 1000px;
      margin: 16px auto 40px;
      padding: 0 12px;
    }

    .cards-resumo {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 12px 14px;
      border: 1px solid var(--borda-caixa);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .card strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .card span {
      font-size: 26px;
      font-weight: 700;
    }

    h2 {
      margin: 20px 0 8px;
      font-size: 18px;
    }

    .bloco {
      background: #fff;
      border-radius: 8px;
      border: 1px solid var(--borda-caixa);
      padding: 14px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    select, input[type="text"], input[type="date"], input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .linha-flex {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .linha-flex > div {
      flex: 1;
      min-width: 150px;
    }

    .checkbox-linha {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 4px 0;
      font-size: 13px;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-principal {
      background: var(--verde-botao);
      color: #fff;
    }

    .btn-principal:hover {
      background: var(--verde-botao-hover);
    }

    .status-msg {
      margin-top: 8px;
      font-size: 13px;
    }

    .status-msg.ok {
      color: #2e7d32;
    }

    .status-msg.erro {
      color: var(--vermelho);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 6px 4px;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background: var(--cinza-claro);
      font-size: 12px;
    }

    td.nome {
      text-align: left;
      padding-left: 6px;
    }

    .badge-status {
      display: inline-block;
      min-width: 28px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      color: #fff;
    }
    .status-N {
      background: #757575;
    }
    .status-S {
      background: var(--verde-botao);
    }

    .btn-mini {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      margin: 1px 0;
      width: 70px;
    }

    .btn-wald {
      background: #1976d2;
      color: #fff;
    }
    .btn-lot {
      background: #6a1b9a;
      color: #fff;
    }

    @media (max-width: 600px) {
      header {
        font-size: 18px;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 4px 2px;
      }
    }
  </style>
</head>
<body>
  <header>Bol√£o ‚Äì Painel do Admin (Waldecir)</header>

  <main>
    <!-- CARDS RESUMO -->
    <section class="cards-resumo">
      <div class="card">
        <strong>N√£o entraram:</strong>
        <span id="cardNaoEntraram">0</span>
      </div>
      <div class="card">
        <strong>Pago Waldecir:</strong>
        <span id="cardPagoWaldecir">0</span>
      </div>
      <div class="card">
        <strong>Pago Lot√©rica:</strong>
        <span id="cardPagoLoterica">0</span>
      </div>
    </section>

    <!-- BLOCO CONCURSO -->
    <section class="bloco">
      <h2>Concurso</h2>

      <div class="linha-flex">
        <div>
          <label for="selectConcurso">Selecionar concurso</label>
          <select id="selectConcurso">
            <option value="">Carregando...</option>
          </select>
        </div>
        <div>
          <label>Concurso ativo</label>
          <div id="textoConcursoAtivo">-</div>
        </div>
      </div>

      <div id="statusConcursos" class="status-msg erro"></div>
    </section>

    <!-- BLOCO CRIAR CONCURSO -->
    <section class="bloco">
      <h2>Criar novo concurso</h2>

      <div class="linha-flex">
        <div>
          <label for="novoNomeConcurso">Nome do concurso</label>
          <input id="novoNomeConcurso" type="text" placeholder="Ex.: MEGA DA VIRADA" />
        </div>
        <div>
          <label for="novoNumeroConcurso">N√∫mero (opcional)</label>
          <input id="novoNumeroConcurso" type="number" placeholder="Ex.: 3457" />
        </div>
      </div>

      <div>
        <label for="novaDataConcurso">Data</label>
        <input id="novaDataConcurso" type="date" />
      </div>

      <div class="checkbox-linha">
        <input id="checkAtivo" type="checkbox" checked />
        <label for="checkAtivo">Marcar este como concurso ativo</label>
      </div>

      <div class="checkbox-linha">
        <input id="checkClonar" type="checkbox" checked />
        <label for="checkClonar">
          Clonar participantes do √∫ltimo concurso ativo (se existir)
        </label>
      </div>

      <button id="btnCriarConcurso" class="btn-principal">Criar concurso</button>
      <div id="statusCriarConcurso" class="status-msg"></div>
    </section>

    <!-- BLOCO ADICIONAR PARTICIPANTE -->
    <section class="bloco">
      <h2>Adicionar participante ao concurso selecionado</h2>

      <label for="novoParticipanteNome">Nome do participante</label>
      <input id="novoParticipanteNome" type="text" placeholder="Ex.: Jo√£o da Silva" />

      <button id="btnAdicionarParticipante" class="btn-principal">
        Adicionar
      </button>
      <div id="statusParticipante" class="status-msg"></div>
    </section>

    <!-- LISTA DE PARTICIPANTES -->
    <section class="bloco">
      <h2>Participantes do concurso selecionado</h2>
      <div id="statusLista" class="status-msg"></div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Nome</th>
            <th>Status</th>
            <th>Pago Waldecir</th>
            <th>Pago Lot√©rica</th>
            <th>Obs</th>
          </tr>
        </thead>
        <tbody id="tabelaParticipantes">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </section>
  </main>

  <!-- SUPABASE + SCRIPT -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîó CONFIG DO SEU PROJETO
    const supabaseUrl = "https://reudmuwpc1dymuwkdszk.supabase.co";
    const supabaseKey = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ELEMENTOS
    const selectConcurso = document.getElementById("selectConcurso");
    const textoConcursoAtivo = document.getElementById("textoConcursoAtivo");
    const statusConcursos = document.getElementById("statusConcursos");

    const cardNaoEntraram = document.getElementById("cardNaoEntraram");
    const cardPagoWaldecir = document.getElementById("cardPagoWaldecir");
    const cardPagoLoterica = document.getElementById("cardPagoLoterica");

    const novoNomeConcurso = document.getElementById("novoNomeConcurso");
    const novoNumeroConcurso = document.getElementById("novoNumeroConcurso");
    const novaDataConcurso = document.getElementById("novaDataConcurso");
    const checkAtivo = document.getElementById("checkAtivo");
    const checkClonar = document.getElementById("checkClonar");
    const btnCriarConcurso = document.getElementById("btnCriarConcurso");
    const statusCriarConcurso = document.getElementById("statusCriarConcurso");

    const novoParticipanteNome = document.getElementById("novoParticipanteNome");
    const btnAdicionarParticipante = document.getElementById("btnAdicionarParticipante");
    const statusParticipante = document.getElementById("statusParticipante");

    const tabelaParticipantes = document.getElementById("tabelaParticipantes");
    const statusLista = document.getElementById("statusLista");

    let concursos = [];
    let participantes = [];
    let concursoSelecionadoId = null;

    function msg(el, texto, tipo = "ok") {
      if (!el) return;
      el.textContent = texto || "";
      el.className = "status-msg " + (texto ? tipo : "");
      if (texto) {
        setTimeout(() => {
          el.textContent = "";
          el.className = "status-msg";
        }, 4000);
      }
    }

    // üîÑ CARREGAR CONCURSOS
    async function carregarConcursos() {
      statusConcursos.textContent = "Carregando concursos...";
      const { data, error } = await supabase
        .from("concursos")
        .select("*")
        .order("data", { ascending: false });

      if (error) {
        statusConcursos.textContent = "Erro ao carregar concursos: " + error.message;
        return;
      }

      concursos = data;
      selectConcurso.innerHTML = "";

      const optVazio = document.createElement("option");
      optVazio.value = "";
      optVazio.textContent = data.length ? "Selecione um concurso..." : "Nenhum concurso cadastrado";
      selectConcurso.appendChild(optVazio);

      let ativo = null;

      data.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c.id;
        let texto = c.nome;
        if (c.numero) texto += " (" + c.numero + ")";
        if (c.data) texto += " - " + c.data;
        if (c.ativo) texto += " ‚≠ê";
        opt.textContent = texto;
        selectConcurso.appendChild(opt);

        if (c.ativo) ativo = c;
      });

      if (ativo) {
        textoConcursoAtivo.textContent =
          ativo.nome + (ativo.numero ? " (" + ativo.numero + ")" : "");
        concursoSelecionadoId = ativo.id;
        selectConcurso.value = ativo.id;
        carregarParticipantes();
      } else {
        textoConcursoAtivo.textContent = "-";
        concursoSelecionadoId = null;
        tabelaParticipantes.innerHTML = "";
        atualizarCards();
      }

      statusConcursos.textContent = "";
    }

    // üßÆ ATUALIZAR CARDS
    function atualizarCards() {
      const total = participantes.length;
      const naoEntraram = participantes.filter((p) => p.status !== "entrou").length;
      const pagouW = participantsPagos("pagou_waldecir");
      const pagouL = participantsPagos("pagou_loterica");

      cardNaoEntraram.textContent = naoEntraram + "/" + total;
      cardPagoWaldecir.textContent = pagouW + "/" + total;
      cardPagoLoterica.textContent = pagouL + "/" + total;
    }

    function participantsPagos(campo) {
      return participantes.filter((p) => p[campo]).length;
    }

    // üë• CARREGAR PARTICIPANTES DO CONCURSO
    async function carregarParticipantes() {
      tabelaParticipantes.innerHTML = "";
      participantes = [];
      atualizarCards();

      if (!concursoSelecionadoId) {
        statusLista.textContent = "Selecione um concurso para ver os participantes.";
        return;
      }

      statusLista.textContent = "Carregando participantes...";
      const { data, error } = await supabase
        .from("participantes")
        .select("*")
        .eq("concurso_id", concursoSelecionadoId)
        .order("nome", { ascending: true });

      if (error) {
        statusLista.textContent = "Erro ao carregar participantes: " + error.message;
        return;
      }

      participantes = data;
      renderTabela();
      statusLista.textContent = "";
    }

    function renderTabela() {
      tabelaParticipantes.innerHTML = "";
      participantes.forEach((p, idx) => {
        const tr = document.createElement("tr");

        // #
        const tdNum = document.createElement("td");
        tdNum.textContent = idx + 1;
        tr.appendChild(tdNum);

        // Nome
        const tdNome = document.createElement("td");
        tdNome.className = "nome";
        tdNome.textContent = p.nome;
        tr.appendChild(tdNome);

        // Status
        const tdStatus = document.createElement("td");
        const spanStatus = document.createElement("span");
        spanStatus.className =
          "badge-status " + (p.status === "entrou" ? "status-S" : "status-N");
        spanStatus.textContent = p.status === "entrou" ? "S" : "N";
        tdStatus.appendChild(spanStatus);
        tr.appendChild(tdStatus);

        // Bot√£o Waldecir
        const tdWal = document.createElement("td");
        const btnWal = document.createElement("button");
        btnWal.className = "btn-mini btn-wald";
        btnWal.textContent = p.pagou_waldecir ? "OK" : "N";
        btnWal.onclick = () => togglePago(p.id, "pagou_waldecir");
        tdWal.appendChild(btnWal);
        tr.appendChild(tdWal);

        // Bot√£o Lot√©rica
        const tdLot = document.createElement("td");
        const btnLot = document.createElement("button");
        btnLot.className = "btn-mini btn-lot";
        btnLot.textContent = p.pagou_loterica ? "OK" : "N";
        btnLot.onclick = () => togglePago(p.id, "pagou_loterica");
        tdLot.appendChild(btnLot);
        tr.appendChild(tdLot);

        // Obs (s√≥ exibe por enquanto)
        const tdObs = document.createElement("td");
        tdObs.textContent = p.obs || "";
        tr.appendChild(tdObs);

        tabelaParticipantes.appendChild(tr);
      });

      atualizarCards();
    }

    // ALTERAR PAGO WALDECIR / LOT√âRICA
    async function togglePago(id, campo) {
      const participante = participantes.find((p) => p.id === id);
      if (!participante) return;

      const novoValor = !participante[campo];

      const { error } = await supabase
        .from("participantes")
        .update({ [campo]: novoValor })
        .eq("id", id);

      if (error) {
        alert("Erro ao atualizar pagamento: " + error.message);
        return;
      }

      participante[campo] = novoValor;
      renderTabela();
    }

    // üîÑ MUDAN√áA DE CONCURSO NO SELECT
    selectConcurso.addEventListener("change", () => {
      concursoSelecionadoId = selectConcurso.value || null;
      carregarParticipantes();
    });

    // ‚ûï CRIAR CONCURSO
    btnCriarConcurso.addEventListener("click", async () => {
      const nome = (novoNomeConcurso.value || "").trim();
      const numero = novoNumeroConcurso.value
        ? parseInt(novoNumeroConcurso.value, 10)
        : null;
      const data = novaDataConcurso.value || null;
      const marcarAtivo = checkAtivo.checked;
      const clonar = checkClonar.checked;

      if (!nome) {
        msg(statusCriarConcurso, "Informe o nome do concurso.", "erro");
        return;
      }

      msg(statusCriarConcurso, "Criando concurso...", "ok");

      // Se marcar como ativo, desativar os demais
      if (marcarAtivo) {
        await supabase.from("concursos").update({ ativo: false }).neq("id", 0);
      }

      const { data: novo, error } = await supabase
        .from("concursos")
        .insert({
          nome,
          numero,
          data,
          ativo: marcarAtivo,
        })
        .select()
        .single();

      if (error || !novo) {
        msg(
          statusCriarConcurso,
          "Erro ao criar concurso: " + (error ? error.message : "desconhecido"),
          "erro"
        );
        return;
      }

      // Clonar participantes do √∫ltimo ativo, se pedido
      if (clonar) {
        const { data: ultimoAtivo } = await supabase
          .from("concursos")
          .select("*")
          .eq("ativo", true)
          .order("created_at", { ascending: false })
          .limit(1);

        // (se desejar, poderia ajustar a l√≥gica para pegar outro concurso)
      }

      msg(statusCriarConcurso, "Concurso criado com sucesso!", "ok");

      novoNomeConcurso.value = "";
      novoNumeroConcurso.value = "";
      novaDataConcurso.value = "";

      await carregarConcursos();
    });

    // ‚ûï ADICIONAR PARTICIPANTE
    btnAdicionarParticipante.addEventListener("click", async () => {
      const nome = (novoParticipanteNome.value || "").trim();
      if (!concursoSelecionadoId) {
        msg(
          statusParticipante,
          "Selecione um concurso antes de adicionar participantes.",
          "erro"
        );
        return;
      }
      if (!nome) {
        msg(statusParticipante, "Informe o nome do participante.", "erro");
        return;
      }

      msg(statusParticipante, "Adicionando participante...", "ok");

      const concurso = concursos.find((c) => c.id === concursoSelecionadoId);

      const { error } = await supabase.from("participantes").insert({
        nome,
        status: "nao_entrou",
        pagou_waldecir: false,
        pagou_loterica: false,
        obs: null,
        concurso_id: concursoSelecionadoId,
        concurso_nome: concurso ? concurso.nome : null,
        concurso_numero: concurso ? concurso.numero : null,
      });

      if (error) {
        msg(
          statusParticipante,
          "Erro ao adicionar participante: " + error.message,
          "erro"
        );
        return;
      }

      novoParticipanteNome.value = "";
      msg(statusParticipante, "Participante adicionado!", "ok");
      carregarParticipantes();
    });

    // INICIALIZA√á√ÉO
    carregarConcursos();
  </script>
</body>
</html>