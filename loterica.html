<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bolão – Painel da Lotérica</title>

  <style>
    :root{
      --header:#145a2a;
      --bg:#f3f5f7;
      --card:#fff;
      --shadow:0 2px 10px rgba(0,0,0,.08);
      --radius:14px;
      --line:#e7eaee;
      --btn:#0d6efd;
      --btn-ok:#198754;
      --text:#1b1f24;
      --muted:#6b7785;
      --yellow:#fff3b0;
      --green:#e7f6e9;
    }

    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header{
      background:var(--header);
      color:#fff;
      padding:16px 14px;
      font-weight:800;
      text-align:center;
      font-size:20px;
      position:sticky; top:0; z-index:5;
    }
    .wrap{ max-width:900px; margin:16px auto 40px; padding:0 12px; }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      border:1px solid var(--line);
      margin-bottom:12px;
    }
    h2{ margin:0 0 10px; font-size:22px; }
    label{ font-weight:700; font-size:14px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select{
      width:100%;
      box-sizing:border-box;
      border:1px solid #cfd6de;
      border-radius:10px;
      padding:10px 12px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:end; }
    .btn{
      border:0;
      padding:10px 14px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      background:var(--btn);
      color:#fff;
      font-size:15px;
      white-space:nowrap;
    }
    .btn-ok{ background:var(--btn-ok); }
    .btn-light{
      background:#eef2f6;
      color:#1b1f24;
      border:1px solid #d9e1ea;
    }
    .msg{ margin-top:8px; font-weight:800; }
    .msg.ok{ color:#0f7b3f; }
    .msg.err{ color:#c62828; }

    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; background:#fff; border:1px solid var(--line); }
    thead th{
      background:#f6b000;
      color:#1b1f24;
      font-weight:900;
      padding:10px;
      text-align:left;
      font-size:14px;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
      font-size:16px;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .col-num{ width:48px; text-align:center; font-weight:900; }

    .st-pro{ background: var(--yellow); }
    .st-pago{ background: var(--green); }
    .st-nao{ background: #fff; }
  </style>
</head>

<body>
  <header>Bolão – Painel da Lotérica</header>

  <div class="wrap">
    <div class="card">
      <h2>Concurso</h2>
      <div class="row">
        <div>
          <label>Selecionar concurso</label>
          <select id="selectConcurso"></select>
          <div class="msg err" id="msgConcursos" style="display:none"></div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:900; color:var(--muted);">Total recebidos na Lotérica</div>
          <div style="font-size:34px; font-weight:900;" id="kpiLot">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Incluir participante (PIX na Lotérica)</h2>
      <label>Nome do participante</label>
      <div class="row">
        <input id="novoNome" placeholder="Ex.: João da Silva" />
        <button class="btn" id="btnIncluir">Incluir</button>
      </div>
      <div class="msg" id="msgIncluir"></div>
    </div>

    <div class="card">
      <h2>Participantes</h2>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th class="col-num">#</th>
              <th>Nome</th>
              <th>Pago na Lotérica</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="msg err" id="msgTabela" style="display:none"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // =========================
    // CONFIG (PREENCHA AQUI)
    // =========================
    const SUPABASE_URL = "https://SEU-PROJETO.supabase.co";
    const SUPABASE_ANON_KEY = "SUA_PUBLISHABLE_KEY_AQUI";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let concursoSelecionadoId = null;
    let concursos = [];
    let participantes = [];
    let channelParticipantes = null;
    let channelConcursos = null;

    function normalizeStatus(raw){
      const v = (raw ?? "").toString().trim();
      if (!v) return "nao_entrou";
      if (v === "Pc" || v === "Pe") return "prometeu";
      const low = v.toLowerCase();
      if (low === "nao_entrou" || low === "nao entrou" || low === "não entrou") return "nao_entrou";
      if (low === "prometeu") return "prometeu";
      if (low === "pago" || low === "pagou") return "pago";
      return "prometeu";
    }

    function rowClassByStatus(st){
      if (st === "prometeu") return "st-pro";
      if (st === "pago") return "st-pago";
      return "st-nao";
    }

    function showMsg(el, text, ok=false){
      el.style.display = "block";
      el.className = "msg " + (ok ? "ok" : "err");
      el.textContent = text || "";
      if (!text) el.style.display = "none";
    }

    async function loadConcursos(){
      const msg = document.getElementById("msgConcursos");
      showMsg(msg, "");

      const { data, error } = await supabase
        .from("concursos")
        .select("id,nome,numero,data,ativo")
        .order("criado_em", { ascending:false })
        .order("created_at", { ascending:false });

      if (error){
        showMsg(msg, "Erro ao carregar concursos: " + error.message);
        return;
      }

      concursos = data || [];
      const sel = document.getElementById("selectConcurso");
      sel.innerHTML = "";

      if (concursos.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Nenhum concurso";
        sel.appendChild(opt);
        concursoSelecionadoId = null;
        await loadParticipantes();
        return;
      }

      for (const c of concursos){
        const opt = document.createElement("option");
        opt.value = c.id;
        const num = (c.numero ?? "");
        opt.textContent = num ? `${c.nome} (${num})` : `${c.nome} ()`;
        sel.appendChild(opt);
      }

      if (!concursoSelecionadoId || !concursos.some(c => c.id === concursoSelecionadoId)){
        concursoSelecionadoId = concursos[0].id;
      }
      sel.value = concursoSelecionadoId;

      await loadParticipantes();
      subscribeParticipantes(concursoSelecionadoId);
    }

    async function loadParticipantes(){
      const msg = document.getElementById("msgTabela");
      showMsg(msg, "");

      if (!concursoSelecionadoId){
        participantes = [];
        renderTabela();
        renderKPI();
        return;
      }

      const { data, error } = await supabase
        .from("participantes")
        .select("id,nome,status,pagou_loterica,concurso_id")
        .eq("concurso_id", concursoSelecionadoId)
        .order("created_at", { ascending:true });

      if (error){
        showMsg(msg, "Erro ao carregar participantes: " + error.message);
        participantes = [];
        renderTabela();
        renderKPI();
        return;
      }

      participantes = (data || []).map(p => ({
        ...p,
        status: normalizeStatus(p.status),
        pagou_loterica: !!p.pagou_loterica
      }));

      renderTabela();
      renderKPI();
    }

    function renderKPI(){
      const lot = participantes.filter(p => !!p.pagou_loterica).length;
      document.getElementById("kpiLot").textContent = lot;
    }

    function renderTabela(){
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      participantes.forEach((p, idx) => {
        const tr = document.createElement("tr");
        tr.className = rowClassByStatus(normalizeStatus(p.status));

        const tdN = document.createElement("td");
        tdN.className = "col-num";
        tdN.textContent = (idx+1);
        tr.appendChild(tdN);

        const tdNome = document.createElement("td");
        tdNome.textContent = p.nome || "";
        tr.appendChild(tdNome);

        const tdPago = document.createElement("td");
        tdPago.textContent = p.pagou_loterica ? "Pago" : "-";
        tr.appendChild(tdPago);

        const tdAc = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "btn " + (p.pagou_loterica ? "btn-ok" : "btn-light");
        btn.textContent = p.pagou_loterica ? "Pago" : "Marcar pago";
        btn.addEventListener("click", async () => {
          await updateParticipante(p.id, { pagou_loterica: !p.pagou_loterica });
        });
        tdAc.appendChild(btn);
        tr.appendChild(tdAc);

        tbody.appendChild(tr);
      });
    }

    async function updateParticipante(id, patch){
      const msg = document.getElementById("msgTabela");
      showMsg(msg, "");

      const { error } = await supabase
        .from("participantes")
        .update(patch)
        .eq("id", id);

      if (error){
        showMsg(msg, "Erro ao atualizar: " + error.message);
        return;
      }

      await loadParticipantes();
    }

    async function incluirParticipante(){
      const msg = document.getElementById("msgIncluir");
      showMsg(msg, "");

      if (!concursoSelecionadoId){
        showMsg(msg, "Selecione um concurso primeiro.");
        return;
      }

      const nome = document.getElementById("novoNome").value.trim();
      if (!nome){
        showMsg(msg, "Informe o nome do participante.");
        return;
      }

      // PIX na lotérica: já entra como PROMETEU e pagou_loterica = true
      const payload = {
        nome,
        status: "prometeu",
        pagou_loterica: true,
        pagou_waldecir: false,
        obs: "",
        concurso_id: concursoSelecionadoId
      };

      const { error } = await supabase
        .from("participantes")
        .insert(payload);

      if (error){
        showMsg(msg, "Erro ao incluir: " + error.message);
        return;
      }

      showMsg(msg, "Participante incluído.", true);
      document.getElementById("novoNome").value = "";
      await loadParticipantes();
    }

    function subscribeParticipantes(concursoId){
      if (channelParticipantes){
        supabase.removeChannel(channelParticipantes);
        channelParticipantes = null;
      }
      if (!concursoId) return;

      channelParticipantes = supabase
        .channel("rt-participantes-loterica-" + concursoId)
        .on("postgres_changes",
          { event:"*", schema:"public", table:"participantes", filter:`concurso_id=eq.${concursoId}` },
          async () => { await loadParticipantes(); }
        )
        .subscribe();
    }

    function subscribeConcursos(){
      if (channelConcursos){
        supabase.removeChannel(channelConcursos);
        channelConcursos = null;
      }
      channelConcursos = supabase
        .channel("rt-concursos-loterica")
        .on("postgres_changes",
          { event:"*", schema:"public", table:"concursos" },
          async () => { await loadConcursos(); }
        )
        .subscribe();
    }

    document.getElementById("selectConcurso").addEventListener("change", async (e) => {
      concursoSelecionadoId = e.target.value || null;
      await loadParticipantes();
      subscribeParticipantes(concursoSelecionadoId);
    });

    document.getElementById("btnIncluir").addEventListener("click", incluirParticipante);

    (async () => {
      subscribeConcursos();
      await loadConcursos();
    })();
  </script>
</body>
</html>
