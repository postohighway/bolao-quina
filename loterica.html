<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel da Lotérica</title>

  <style>
    :root{--green:#2e7d32;--green2:#1b5e20;--orange:#f2b705;--line:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb}
    header{background:var(--green);color:#fff;padding:14px 16px;font-weight:900;text-align:center;font-size:20px}
    .wrap{max-width:900px;margin:16px auto;padding:0 12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:14px;margin-bottom:12px}
    label{font-weight:800}
    input,select,button{font:inherit;border:1px solid #cfd4dc;border-radius:10px;padding:10px 12px;background:#fff}
    button{cursor:pointer;border:none;color:#fff;font-weight:900}
    .btn-green{background:var(--green)}
    .btn-green:hover{background:var(--green2)}
    .btn-blue{background:#1976d2}
    .btn-blue:hover{background:#155fb0}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .err{color:#b91c1c;font-weight:900;margin-top:8px}
    .ok{color:#166534;font-weight:900;margin-top:8px}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    thead th{background:var(--orange);padding:12px 10px;text-align:left;font-weight:900}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody tr:last-child td{border-bottom:none}
    tr.st-nao_vai{background:#fde8e8}
    tr.st-prometeu{background:#fff7d1}
    tr.st-pagou{background:#e8f7ea}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;border:1px solid rgba(0,0,0,.08)}
    .pill-ok{background:var(--green);color:#fff}
    .pill-no{background:#e5e7eb;color:#111}

    @media (max-width:820px){
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody td{border:none;border-bottom:1px dashed #e5e7eb}
      tbody td::before{content:attr(data-label);display:block;font-size:12px;color:var(--muted);font-weight:900;margin-bottom:4px}
      tbody td:last-child{border-bottom:none}
    }
  </style>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
<header>Bolão – Painel da Lotérica</header>

<div class="wrap">

  <div class="card">
    <label for="selectConcurso">Selecionar concurso</label><br/>
    <select id="selectConcurso" style="width:100%"></select>
    <div class="hint">Total recebidos na Lotérica: <b id="totalLoterica">0</b></div>
    <div id="msgTop"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;">Incluir participante (PIX na Lotérica)</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:220px;">
        <label>Nome do participante</label><br/>
        <input id="novoNome" placeholder="Ex.: João da Silva" style="width:100%" />
        <div class="hint">Ao incluir aqui, já marca “Pago na Lotérica”.</div>
      </div>
      <div style="min-width:180px;align-self:flex-end;">
        <button class="btn-blue" id="btnIncluir" style="width:100%">Incluir</button>
      </div>
    </div>
    <div id="msgIncluir"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0;">Participantes</h3>
    <table>
      <thead>
        <tr>
          <th style="width:50px;">#</th>
          <th>Nome</th>
          <th style="width:140px;">Status</th>
          <th style="width:160px;">Pago na Lotérica</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<script>
  const supabaseUrl = "https://reudmuwpcldymuwkdszk.supabase.co";
  const supabaseKey = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B";
  const sb = supabase.createClient(supabaseUrl, supabaseKey);

  let concursos = [];
  let concursoSelecionadoId = null;

  const elSelect = document.getElementById("selectConcurso");
  const elTbody = document.getElementById("tbody");
  const elMsgTop = document.getElementById("msgTop");
  const elTotal = document.getElementById("totalLoterica");
  const elMsgIncluir = document.getElementById("msgIncluir");

  function msg(el, texto, ok=false){
    el.innerHTML = texto ? `<div class="${ok?'ok':'err'}">${texto}</div>` : "";
  }
  function rowClassByStatus(v){
    if(v==="nao_vai") return "st-nao_vai";
    if(v==="prometeu") return "st-prometeu";
    if(v==="pagou") return "st-pagou";
    return "";
  }
  function statusLabel(v){
    if(v==="nao_vai") return "Não vai";
    if(v==="prometeu") return "Prometeu";
    if(v==="pagou") return "Pagou";
    return "—";
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function carregarConcursos(){
    msg(elMsgTop,"");
    elSelect.innerHTML = `<option value="">Carregando...</option>`;
    try{
      const { data, error } = await sb
        .from("concursos")
        .select("id,nome,numero,created_at")
        .order("created_at", { ascending:false });

      if(error) throw error;
      concursos = data || [];
      if(!concursos.length){
        elSelect.innerHTML = `<option value="">(Nenhum concurso)</option>`;
        concursoSelecionadoId = null;
        render([]);
        return;
      }

      elSelect.innerHTML = concursos.map(c=>{
        const label = `${c.nome}${c.numero ? " ("+c.numero+")" : ""}`;
        return `<option value="${c.id}">${label}</option>`;
      }).join("");

      concursoSelecionadoId = concursos[0].id;
      elSelect.value = concursoSelecionadoId;
      await carregarParticipantes();
    }catch(e){
      msg(elMsgTop, `Erro ao carregar concursos: ${e.message || e}`);
      elSelect.innerHTML = `<option value="">(Erro)</option>`;
    }
  }

  async function carregarParticipantes(){
    if(!concursoSelecionadoId){ render([]); return; }
    try{
      const { data, error } = await sb
        .from("participantes")
        .select("id,nome,status,pagou_loterica")
        .eq("concurso_id", concursoSelecionadoId)
        .order("nome", { ascending:true });

      if(error) throw error;
      const participantes = data || [];
      const total = participantes.filter(p=>p.pagou_loterica===true).length;
      elTotal.textContent = total;
      render(participantes);
    }catch(e){
      msg(elMsgTop, `Erro ao carregar participantes: ${e.message || e}`);
      render([]);
    }
  }

  function render(participantes){
    elTbody.innerHTML = "";
    participantes.forEach((p, idx)=>{
      const tr = document.createElement("tr");
      tr.className = rowClassByStatus(p.status);
      tr.innerHTML = `
        <td data-label="#">${idx+1}</td>
        <td data-label="Nome" style="font-weight:900;">${escapeHtml(p.nome||"")}</td>
        <td data-label="Status">${statusLabel(p.status)}</td>
        <td data-label="Pago na Lotérica">
          ${
            p.pagou_loterica
              ? `<span class="pill pill-ok">OK</span> <button class="btn-green" data-act="toggle" data-id="${p.id}" style="margin-left:8px;">Desmarcar</button>`
              : `<span class="pill pill-no">—</span> <button class="btn-green" data-act="toggle" data-id="${p.id}" style="margin-left:8px;">Marcar pago</button>`
          }
        </td>
      `;
      elTbody.appendChild(tr);
    });

    elTbody.querySelectorAll("[data-act='toggle']").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const virarTrue = btn.textContent.includes("Marcar");
        try{
          const { error } = await sb.from("participantes").update({ pagou_loterica: virarTrue }).eq("id", id);
          if(error) throw error;
          await carregarParticipantes();
        }catch(e){
          alert(`Falha ao salvar: ${e.message || e}`);
        }
      });
    });
  }

  async function incluirParticipante(){
    msg(elMsgIncluir,"");
    const nome = document.getElementById("novoNome").value.trim();
    if(!concursoSelecionadoId){ msg(elMsgIncluir,"Selecione um concurso."); return; }
    if(!nome){ msg(elMsgIncluir,"Digite um nome."); return; }

    try{
      const payload = {
        concurso_id: concursoSelecionadoId,
        nome,
        status: "prometeu",
        pagou_waldecir: false,
        pagou_loterica: true,
        obs: null
      };
      const { error } = await sb.from("participantes").insert(payload);
      if(error) throw error;

      msg(elMsgIncluir,"Incluído e marcado como pago na Lotérica!", true);
      document.getElementById("novoNome").value = "";
      await carregarParticipantes();
    }catch(e){
      msg(elMsgIncluir, `Erro ao incluir: ${e.message || e}`);
    }
  }

  elSelect.addEventListener("change", async ()=>{
    concursoSelecionadoId = elSelect.value || null;
    await carregarParticipantes();
  });

  document.getElementById("btnIncluir").addEventListener("click", incluirParticipante);

  carregarConcursos();
</script>
</body>
</html>
