<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel da Lotérica</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--green:#1b5e20;--bg:#f3f5f7;--shadow:0 10px 30px rgba(0,0,0,.08);--r:16px}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{background:var(--green);color:#fff;padding:16px 20px;font-weight:900;text-align:center;font-size:22px}
    .wrap{max-width:1100px;margin:16px auto;padding:0 14px}
    .card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:14px;margin-top:14px}
    label{display:block;font-weight:800;margin:10px 0 6px}
    input,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:15px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn-green{background:var(--green);color:#fff}
    .err{background:#ffe4e6;border:1px solid #fecdd3;color:#9f1239;padding:10px;border-radius:12px;margin-top:10px;font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;box-shadow:var(--shadow);background:#fff}
    thead th{background:#f6b100;color:#111827;text-align:left;padding:12px;font-weight:900}
    tbody td{padding:10px;border-top:1px solid #eef2f7;vertical-align:middle}
    .pill{display:inline-block;padding:6px 10px;border-radius:10px;font-weight:900;font-size:13px}
    .pill-ok{background:#1f7a2a;color:#fff}
    .btn-sm{padding:8px 12px;border-radius:10px;font-weight:900}
    .btn-gray{background:#6b7280;color:#fff}
    .rowStatus-nao_entrou{background:#ffe7e7}
    .rowStatus-Pe{background:#fff7cc}
    .rowStatus-Pc{background:#e6f4ff}
    .rowStatus-pago{background:#e7f7ea}
  </style>
</head>
<body>
<header>Bolão – Painel da Lotérica</header>

<div class="wrap">
  <div class="card">
    <label>Selecionar concurso</label>
    <select id="selConcurso"></select>
    <div id="msg"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px">Incluir participante (PIX na Lotérica)</h2>
    <label>Nome do participante</label>
    <div style="display:grid;grid-template-columns:1fr 180px;gap:12px">
      <input id="addNome" placeholder="Ex.: João da Silva" />
      <button class="btn btn-green" id="btnAdd">Incluir</button>
    </div>
  </div>

  <div style="margin-top:14px">
    <table>
      <thead>
        <tr>
          <th style="width:60px">#</th>
          <th>Nome</th>
          <th style="width:160px">Status</th>
          <th style="width:160px">Pago na Lotérica</th>
        </tr>
      </thead>
      <tbody id="tb"></tbody>
    </table>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://reudmuwpcldymuwkdszk.supabase.co";
  const SUPABASE_KEY = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  const $ = (id) => document.getElementById(id);
  const msg = (text) => $("msg").innerHTML = `<div class="err">${text}</div>`;
  const clearMsg = () => $("msg").innerHTML = "";

  let concursoSelId = null;
  let participantes = [];

  function statusText(v){
    switch(v){
      case "nao_entrou": return "Não vai";
      case "Pe": return "Prometeu";
      case "Pc": return "Confirmado";
      case "pago": return "Pago";
      default: return "Prometeu";
    }
  }

  async function loadConcursos(){
    clearMsg();
    $("selConcurso").innerHTML = `<option value="">Carregando...</option>`;
    const { data, error } = await sb.from("concursos").select("id,nome,numero,created_at").order("created_at",{ascending:false});
    if (error) throw error;

    if (!data?.length){
      $("selConcurso").innerHTML = `<option value="">(sem concursos)</option>`;
      concursoSelId = null;
      return;
    }
    if (!concursoSelId) concursoSelId = data[0].id;

    $("selConcurso").innerHTML = data.map(c=>{
      const label = `${c.nome}${c.numero ? " ("+c.numero+")" : ""}`;
      return `<option value="${c.id}" ${c.id===concursoSelId?"selected":""}>${label}</option>`;
    }).join("");

    await loadParticipantes();
  }

  async function loadParticipantes(){
    if (!concursoSelId){ $("tb").innerHTML=""; return; }
    const { data, error } = await sb
      .from("participantes")
      .select("id,nome,status,pagou_loterica,created_at,concurso_id")
      .eq("concurso_id", concursoSelId)
      .order("created_at",{ascending:true});
    if (error) throw error;
    participantes = data || [];
    render();
  }

  function render(){
    $("tb").innerHTML = participantes.map((p,i)=>{
      const st = p.status || "Pe";
      return `
        <tr class="rowStatus-${st}">
          <td style="font-weight:900">${i+1}</td>
          <td style="font-weight:900">${(p.nome||"")}</td>
          <td>${statusText(st)}</td>
          <td>
            ${p.pagou_loterica ? `<span class="pill pill-ok">Pago</span>` :
              `<button class="btn-sm btn-gray" data-id="${p.id}">Marcar pago</button>`}
          </td>
        </tr>
      `;
    }).join("");

    document.querySelectorAll("button[data-id]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const id = b.getAttribute("data-id");
        try{
          clearMsg();
          const { error } = await sb.from("participantes").update({ pagou_loterica:true }).eq("id", id);
          if (error) throw error;
          await loadParticipantes();
        }catch(e){
          msg("Erro ao marcar: " + (e?.message||e));
        }
      });
    });
  }

  async function addParticipante(){
    const nome = ($("addNome").value || "").trim();
    if (!concursoSelId) return msg("Selecione um concurso.");
    if (!nome) return msg("Informe o nome do participante.");

    try{
      clearMsg();
      const row = {
        concurso_id: concursoSelId,
        nome,
        status: "Pe",
        pagou_waldecir: false,
        pagou_loterica: true, // entrou via lotérica
        obs: ""
      };
      const { error } = await sb.from("participantes").insert(row);
      if (error) throw error;
      $("addNome").value = "";
      await loadParticipantes();
    }catch(e){
      msg("Erro ao incluir: " + (e?.message||e));
    }
  }

  (async function init(){
    try{
      $("selConcurso").addEventListener("change", async ()=>{
        concursoSelId = $("selConcurso").value || null;
        await loadParticipantes();
      });
      $("btnAdd").addEventListener("click", addParticipante);
      await loadConcursos();
    }catch(e){
      msg("Erro ao carregar concursos: " + (e?.message || e) + "<br><br>Se aparecer <b>Failed to fetch</b>: confira URL e se a key é <b>sb_publishable_</b>.");
      console.error(e);
    }
  })();
</script>
</body>
</html>

