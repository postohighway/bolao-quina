<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bolão – Painel da Lotérica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }
    header {
      background: #2e7d32;
      color: #fff;
      padding: 12px 16px;
      text-align: center;
      font-weight: 600;
      font-size: 18px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .card h3 { margin: 0 0 6px 0; font-size: 15px; }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
      font-weight: 500;
    }
    select {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .status-msg {
      font-size: 12px;
      margin-top: 4px;
      color: #d32f2f;
    }
    .status-msg.ok {
      color: #2e7d32;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,.15);
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
    }
    thead { background: #ffb300; }
    th:nth-child(1), td:nth-child(1) {
      width: 40px;
      text-align: center;
    }
    th:nth-child(3), td:nth-child(3) {
      text-align: center;
    }
    .btn-flag {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
    }
    .btn-flag.pago {
      background: #2e7d32;
      color: #fff;
      border-color: #1b5e20;
      font-weight: 600;
    }
    tr.pago {
      background: #c8e6c9 !important;
    }
  </style>
</head>
<body>
  <header>Bolão – Painel da Lotérica</header>
  <div class="container">
    <div class="card">
      <h3>Concurso</h3>
      <label for="selectConcurso">Selecionar concurso</label>
      <select id="selectConcurso"></select>
      <div class="status-msg" id="statusConcursos"></div>
      <div style="margin-top:6px; font-size:13px;">
        <strong>Total recebidos na Lotérica:</strong>
        <span id="totalLot">0</span>
      </div>
    </div>

    <div class="card">
      <h3>Participantes</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Nome</th>
            <th>Pago na Lotérica</th>
          </tr>
        </thead>
        <tbody id="tbodyParticipantes"></tbody>
      </table>
      <div class="status-msg" id="statusParticipantes"></div>
    </div>
  </div>

  <script>
    const { createClient } = supabase;

    const supabaseUrl = "https://reudmuwpcldymuwkdszk.supabase.co";
    const supabaseKey = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B";
    const sb = createClient(supabaseUrl, supabaseKey);

    let concursos = [];
    let participantes = [];
    let concursoSelecionadoId = null;

    const selectConcurso = document.getElementById("selectConcurso");
    const statusConcursos = document.getElementById("statusConcursos");
    const statusParticipantes = document.getElementById("statusParticipantes");
    const tbodyParticipantes = document.getElementById("tbodyParticipantes");
    const totalLot = document.getElementById("totalLot");

    function msg(el, texto, ok=false) {
      el.textContent = texto;
      el.className = "status-msg" + (ok ? " ok" : "");
      if (texto) {
        setTimeout(() => {
          if (el.textContent === texto) el.textContent = "";
        }, 4000);
      }
    }

    function atualizarResumo() {
      const qtde = participantes.filter(p => p.pagou_loterica).length;
      totalLot.textContent = qtde;
    }

    function renderParticipantes() {
      tbodyParticipantes.innerHTML = "";
      if (!participantes || participantes.length === 0) {
        atualizarResumo();
        return;
      }
      const sorted = [...participantes].sort((a,b) => a.nome.localeCompare(b.nome, "pt-BR"));
      sorted.forEach((p, idx) => {
        const tr = document.createElement("tr");
        if (p.pagou_loterica) tr.classList.add("pago");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = idx + 1;

        const tdNome = document.createElement("td");
        tdNome.textContent = p.nome;

        const tdBtn = document.createElement("td");
        tdBtn.style.textAlign = "center";
        const btn = document.createElement("button");
        btn.className = "btn-flag";
        if (p.pagou_loterica) btn.classList.add("pago");
        btn.textContent = p.pagou_loterica ? "Pago" : "Marcar pago";
        tdBtn.appendChild(btn);

        tr.appendChild(tdIdx);
        tr.appendChild(tdNome);
        tr.appendChild(tdBtn);
        tbodyParticipantes.appendChild(tr);

        btn.addEventListener("click", async () => {
          const novo = !p.pagou_loterica;
          btn.disabled = true;
          const { error } = await sb
            .from("participantes")
            .update({ pagou_loterica: novo })
            .eq("id", p.id);
          btn.disabled = false;
          if (!error) {
            p.pagou_loterica = novo;
            btn.textContent = novo ? "Pago" : "Marcar pago";
            btn.classList.toggle("pago", novo);
            if (novo) tr.classList.add("pago"); else tr.classList.remove("pago");
            atualizarResumo();
          } else {
            msg(statusParticipantes, "Erro ao atualizar pagamento: " + error.message);
          }
        });
      });
      atualizarResumo();
    }

    async function carregarParticipantes(idConc) {
      participantes = [];
      tbodyParticipantes.innerHTML = "";
      if (!idConc) {
        atualizarResumo();
        return;
      }
      msg(statusParticipantes, "Carregando participantes...");
      const { data, error } = await sb
        .from("participantes")
        .select("*")
        .eq("concurso_id", idConc);

      if (error) {
        msg(statusParticipantes, "Erro ao carregar participantes: " + error.message);
        return;
      }
      participantes = data || [];
      msg(statusParticipantes, "");
      renderParticipantes();
    }

    async function carregarConcursos() {
      msg(statusConcursos, "Carregando concursos...");
      const { data, error } = await sb
        .from("concursos")
        .select("*")
        .order("data", { ascending: false })
        .order("created_at", { ascending: false });

      if (error) {
        msg(statusConcursos, "Invalid API key ou erro: " + error.message);
        return;
      }

      concursos = data || [];
      selectConcurso.innerHTML = "";
      if (concursos.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Nenhum concurso cadastrado";
        selectConcurso.appendChild(opt);
        concursoSelecionadoId = null;
        await carregarParticipantes(null);
        msg(statusConcursos, "");
        return;
      }

      let ativo = concursos.find(c => c.ativo);
      if (!ativo) ativo = concursos[0];

      concursos.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        const numStr = c.numero ? ` #${c.numero}` : "";
        opt.textContent = `${c.nome}${numStr} (${c.data || ""})`;
        if (c.id === ativo.id) opt.selected = true;
        selectConcurso.appendChild(opt);
      });

      concursoSelecionadoId = ativo.id;
      msg(statusConcursos, "");
      await carregarParticipantes(concursoSelecionadoId);
    }

    selectConcurso.addEventListener("change", async () => {
      concursoSelecionadoId = selectConcurso.value || null;
      await carregarParticipantes(concursoSelecionadoId);
    });

    document.addEventListener("DOMContentLoaded", () => {
      carregarConcursos();
    });
  </script>
</body>
</html>
