<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Bolão – Painel da Lotérica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f4f4f4;
      color: #222;
    }
    .topbar {
      background: #1b5e20;
      color: #fff;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }
    h2 { font-size: 18px; margin-bottom: 8px; }
    label {
      display: block;
      font-size: 14px;
      margin: 8px 0 4px;
    }
    input[type="text"], select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .row { display: flex; flex-wrap: wrap; gap: 8px; }
    .row > div { flex: 1; min-width: 150px; }
    .status-msg { font-size: 13px; margin-top: 6px; min-height: 16px; }
    .status-msg.ok { color: #1b5e20; }
    .status-msg.err { color: #c62828; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 14px; }
    thead { background: #ffb300; }
    thead th { padding: 8px; text-align: left; }
    tbody td { padding: 6px 8px; border-bottom: 1px solid #eee; }
    tbody tr:nth-child(odd) { background: #f3f9f3; }
    .td-center { text-align: center; }
    .small-btn {
      padding: 4px 8px;
      border-radius: 4px;
      border: none;
      font-size: 12px;
    }
    .btn-danger { background: #c62828; color: #fff; }
    button { cursor: pointer; }
    .btn-main {
      width: 100%; margin-top: 8px; padding: 10px;
      border-radius: 6px; border: none;
      background: #1565c0; color: #fff;
      font-size: 16px; font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="topbar">Bolão – Painel da Lotérica</div>

  <div class="container">
    <!-- Concurso -->
    <div class="section">
      <h2>Concurso</h2>
      <div class="row">
        <div>
          <label for="selectConcurso">Selecionar concurso</label>
          <select id="selectConcurso">
            <option selected disabled>Carregando...</option>
          </select>
        </div>
        <div>
          <label>Total recebidos na Lotérica</label>
          <div style="font-size:28px;font-weight:700;" id="totalLoterica">0</div>
        </div>
      </div>
      <div id="statusConcursos" class="status-msg"></div>
    </div>

    <!-- Participantes -->
    <div class="section">
      <h2>Participantes</h2>
      <table id="tabelaParticipantes">
        <thead>
          <tr>
            <th style="width:40px;">#</th>
            <th>Nome</th>
            <th class="td-center" style="width:110px;">Pago na Lotérica</th>
            <th class="td-center" style="width:80px;">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="statusLista" class="status-msg"></div>
    </div>

    <!-- Incluir participante -->
    <div class="section">
      <h2>Incluir participante (PIX na Lotérica)</h2>
      <label for="novoNome">Nome do participante</label>
      <input id="novoNome" type="text" placeholder="Ex.: João da Silva" />
      <button id="btnIncluir" class="btn-main">Incluir</button>
      <div id="statusIncluir" class="status-msg"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://reudmuwpcldymuwkdszk.supabase.co";
    const supabaseKey = "sb_publishable_i8PskNVeOK3YFniGzy2Eog_rjWlEZ7B";
    const sb = supabase.createClient(supabaseUrl, supabaseKey);

    let concursos = [];
    let concursoSelecionadoId = null;

    const selectConcurso  = document.getElementById("selectConcurso");
    const totalLoterica   = document.getElementById("totalLoterica");
    const statusConcursos = document.getElementById("statusConcursos");
    const statusLista     = document.getElementById("statusLista");
    const statusIncluir   = document.getElementById("statusIncluir");

    function showMsg(el, msg, ok=false) {
      el.textContent = msg;
      el.className = "status-msg " + (ok ? "ok" : "err");
      if (!msg) return;
      setTimeout(() => { el.textContent = ""; }, 3000);
    }

    async function carregarConcursos() {
      try {
        statusConcursos.textContent = "Carregando concursos...";
        const { data, error } = await sb
          .from("concursos")
          .select("*")
          .order("data", { ascending: false });
        if (error) throw error;

        concursos = data || [];
        selectConcurso.innerHTML = "";
        statusConcursos.textContent = "";

        if (!concursos.length) {
          const opt = document.createElement("option");
          opt.textContent = "Nenhum concurso cadastrado";
          opt.disabled = true;
          opt.selected = true;
          selectConcurso.appendChild(opt);
          concursoSelecionadoId = null;
          renderTabela([]);
          atualizarTotal([]);
          return;
        }

        concursos.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.id;
          const num = c.numero ? ` (${c.numero})` : "";
          opt.textContent = `${c.nome}${num}`;
          if (c.ativo) opt.textContent += " ⭐";
          selectConcurso.appendChild(opt);
        });

        const ativo = concursos.find(c => c.ativo);
        const escolhido = ativo || concursos[0];
        selectConcurso.value = escolhido.id;
        concursoSelecionadoId = escolhido.id;
        await carregarParticipantes();
      } catch (err) {
        showMsg(statusConcursos, "Erro ao carregar concursos: " + err.message);
      }
    }

    selectConcurso.addEventListener("change", async () => {
      concursoSelecionadoId = selectConcurso.value || null;
      await carregarParticipantes();
    });

    async function carregarParticipantes() {
      if (!concursoSelecionadoId) {
        renderTabela([]);
        atualizarTotal([]);
        return;
      }
      try {
        const { data, error } = await sb
          .from("participantes")
          .select("*")
          .eq("concurso_id", concursoSelecionadoId)
          .order("nome", { ascending: true });
        if (error) throw error;
        const lista = data || [];
        renderTabela(lista);
        atualizarTotal(lista);
      } catch (err) {
        showMsg(statusLista, "Erro ao carregar participantes: " + err.message);
      }
    }

    function atualizarTotal(lista) {
      const total = lista.filter(p => p.pagou_loterica).length;
      totalLoterica.textContent = total;
    }

    function renderTabela(lista) {
      const tbody = document.querySelector("#tabelaParticipantes tbody");
      tbody.innerHTML = "";
      lista.forEach((p, idx) => {
        const tr = document.createElement("tr");

        const tdIdx = document.createElement("td");
        tdIdx.textContent = idx + 1;

        const tdNome = document.createElement("td");
        tdNome.textContent = p.nome;

        const tdPago = document.createElement("td");
        tdPago.className = "td-center";
        const btnPago = document.createElement("button");
        btnPago.textContent = p.pagou_loterica ? "Pago" : "Marcar pago";
        btnPago.className = "small-btn";
        btnPago.style.background = p.pagou_loterica ? "#2e7d32" : "#eee";
        btnPago.style.color = p.pagou_loterica ? "#fff" : "#000";
        btnPago.onclick = () => togglePagoLoterica(p.id, !p.pagou_loterica);
        tdPago.appendChild(btnPago);

        const tdAcao = document.createElement("td");
        tdAcao.className = "td-center";
        const btnDel = document.createElement("button");
        btnDel.textContent = "Excluir";
        btnDel.className = "small-btn btn-danger";
        btnDel.onclick = () => excluirParticipante(p.id);
        tdAcao.appendChild(btnDel);

        tr.appendChild(tdIdx);
        tr.appendChild(tdNome);
        tr.appendChild(tdPago);
        tr.appendChild(tdAcao);
        tbody.appendChild(tr);
      });
    }

    async function togglePagoLoterica(id, valor) {
      try {
        const { error } = await sb
          .from("participantes")
          .update({ pagou_loterica: valor })
          .eq("id", id);
        if (error) throw error;
        await carregarParticipantes();
      } catch (err) {
        alert("Erro ao atualizar: " + err.message);
      }
    }

    async function excluirParticipante(id) {
      if (!confirm("Remover esse participante deste concurso?")) return;
      try {
        const { error } = await sb
          .from("participantes")
          .delete()
          .eq("id", id);
        if (error) throw error;
        await carregarParticipantes();
      } catch (err) {
        alert("Erro ao excluir: " + err.message);
      }
    }

    document.getElementById("btnIncluir").addEventListener("click", async () => {
      const nome = document.getElementById("novoNome").value.trim();
      if (!concursoSelecionadoId) {
        showMsg(statusIncluir, "Selecione um concurso primeiro.");
        return;
      }
      if (!nome) {
        showMsg(statusIncluir, "Informe o nome do participante.");
        return;
      }
      try {
        const { error } = await sb.from("participantes").insert({
          nome,
          status: "nao_entrou",
          pagou_waldecir: false,
          pagou_loterica: true,   // já entrou com pix pago na lotérica
          obs: null,
          concurso_id: concursoSelecionadoId
        });
        if (error) throw error;
        document.getElementById("novoNome").value = "";
        showMsg(statusIncluir, "Participante incluído!", true);
        await carregarParticipantes();
      } catch (err) {
        showMsg(statusIncluir, "Erro ao incluir: " + err.message);
      }
    });

    carregarConcursos();
  </script>
</body>
</html>