<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bolão – Lista Pública</title>
  <style>
    :root{--verde:#2e7d32;--bg:#f4f6f8;--borda:#e6e6e6;--laranja:#f4b400;--amarelo:#fff8c4}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg)}
    header{background:var(--verde);color:#fff;padding:14px 16px;font-weight:800;text-align:center}
    .wrap{max-width:820px;margin:14px auto;padding:0 12px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08);padding:14px;margin:10px 0}
    label{display:block;font-weight:800;margin:10px 0 6px}
    select{width:100%;padding:12px;border:1px solid var(--borda);border-radius:10px;font-size:16px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden}
    thead th{background:var(--laranja);padding:12px 10px;text-align:left;font-weight:900}
    tbody td{padding:10px;border-bottom:1px solid #eee}
    tbody tr:last-child td{border-bottom:0}
    .linha-ok{background:#cdeed3}
    .linha-pendente{background:var(--amarelo)}
    .linha-nao-entrou{background:#fff}
    .msg{margin-top:8px;font-weight:800}
    .msg.err{color:#b71c1c}
  </style>
</head>
<body>
<header>Bolão – Lista Pública</header>

<div class="wrap">
  <div class="card">
    <label>Concurso</label>
    <select id="selectConcurso"></select>
    <div class="msg err" id="msg"></div>
  </div>

  <div class="card">
    <table id="tabela">
      <thead>
        <tr><th style="width:50px">#</th><th>Nome</th><th style="width:140px">Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://reudmuwpcldymuwkdszk.supabase.co";
  const SUPABASE_KEY = "SUA_PUBLISHABLE_KEY_AQUI"; // sb_publishable_...

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let concursos = [];
  let concursoId = null;

  const elSelect = document.getElementById("selectConcurso");
  const msg = document.getElementById("msg");

  function setMsg(text){ msg.textContent = text || ""; }

  async function carregarConcursos(){
    try{
      setMsg("");
      elSelect.innerHTML = `<option value="">Carregando...</option>`;
      const { data, error } = await sb.from("concursos")
        .select("id,nome,ativo,criado_em")
        .order("criado_em",{ascending:false});
      if(error) throw error;
      concursos = data||[];
      if(!concursos.length){
        elSelect.innerHTML = `<option value="">(nenhum concurso)</option>`;
        return;
      }
      elSelect.innerHTML = `<option value="">Selecione...</option>` +
        concursos.map(c=>`<option value="${c.id}">${c.nome||"Sem nome"}</option>`).join("");
      const ativo = concursos.find(c=>c.ativo);
      const first = ativo || concursos[0];
      concursoId = first.id;
      elSelect.value = concursoId;
      await carregarParticipantes();
    }catch(err){
      setMsg("Erro: " + err.message);
      elSelect.innerHTML = `<option value="">(erro)</option>`;
    }
  }

  async function carregarParticipantes(){
    try{
      setMsg("");
      const tbody = document.querySelector("#tabela tbody");
      tbody.innerHTML = "";
      if(!concursoId) return;

      const { data, error } = await sb.from("participantes")
        .select("nome,status,pagou_waldecir,pagou_loterica")
        .eq("concurso_id", concursoId)
        .order("nome",{ascending:true});
      if(error) throw error;

      (data||[]).forEach((p, idx)=>{
        const tr = document.createElement("tr");
        if(p.pagou_waldecir || p.pagou_loterica) tr.classList.add("linha-ok");
        else if((p.status||"N")==="Pe") tr.classList.add("linha-pendente");
        else tr.classList.add("linha-nao-entrou");

        const statusTxt = (p.pagou_waldecir || p.pagou_loterica) ? "Pago" : (p.status||"N");
        tr.innerHTML = `<td>${idx+1}</td><td><b>${escapeHtml(p.nome||"")}</b></td><td>${escapeHtml(statusTxt)}</td>`;
        tbody.appendChild(tr);
      });
    }catch(err){
      setMsg("Erro: " + err.message);
    }
  }

  elSelect.addEventListener("change", async ()=>{
    concursoId = elSelect.value || null;
    await carregarParticipantes();
  });

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }

  carregarConcursos();
</script>
</body>
</html>